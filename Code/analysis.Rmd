---
title: "generate_pvalue4CurrentManuscript"
date: "`r Sys.Date()`"
author: "Lu Yang & Jun Chen"
output:
 html_document:
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: no
      smooth_scroll: no
---



```{r, message=FALSE, message=F, warning=F, echo=FALSE, results='hide'}
grp.name= 'PR4.n'
adj.name= 'BRAF'
subsetBRAF= FALSE
BRAF.sub=''
```

```{r, message=FALSE, message=F, warning=F, echo=FALSE, results='hide'}
### Previously we use Lymphoctyes_KnitWithParams.Rmd to generate the html files
###########################################
pkg <- c('dplyr','tibble','tidyr','vegan','matrixStats', 'GUniFrac','ggpubr','RColorBrewer','ggplot2','reactable')
sapply(pkg, require, character = T)
# root.dir <- '/research/bsi/projects/staff_analysis/m216453/2022CyTOF/'
root.dir <- '/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/'
list_df <- function(dea.res, list.name = "diff.marker.raw.p"){
  if(class(dea.res[[list.name]])=="list"){
    tb <- NULL
    for(n in 1:length(dea.res[[list.name]])){
      tb <- rbind(tb,dea.res[[list.name]][[n]])
    }
  }
  if(class(dea.res[[list.name]])=="array"){
    tb <- reshape2::melt(dea.res[[list.name]])
    colnames(tb) <- c('TimePoints','variables','celltypes','markers','value')
  }
  return(tb)
}
```

```{r, message=FALSE, message=F, warning=F, echo=FALSE, results='hide'}
# Data source: Astrolabe.R(import the cell count directly from Astrolabe generated csv) and 2022_data.R(generate different types fo cell marker abundance data)
## Add for new classification 'good' vs "bad"[09/13/2022]
# met <- read.csv('/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/meta.csv')
# met <- met[!is.na(met$PR4),]
# met$name <- gsub('-','_',met$name)
# met$name <- gsub('_base_','_baseline_',met$name)
# met$name[!(met$name %in% colnames(Assignment))]
# met$name[!(met$name %in% colnames(Compartment))]
# met$name[!(met$name %in% colnames(Profiling))]
# met$PR4.n <- NA
# met[met$PR4 %in% c("pMR","pPR"),'PR4.n'] <- 'bad'
# met[met$PR4 %in% c("pCR","nc pCR"),'PR4.n'] <- 'good'
# good <- met$filename[met$PR4.n=='good']
# bad <- met$filename[met$PR4.n=='bad']
# files <- list.files('/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022_09_29/')
# files <- files[-1]
# for(i in 1:length(files)){
#   meta.dat <- NULL
#   tm <- load(paste0('/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022_09_29/',files[i]))
#   meta.dat$PR4.n <- NA
#   meta.dat[meta.dat$filename %in% good, 'PR4.n'] <- 'good'
#   meta.dat[meta.dat$filename %in% bad, 'PR4.n'] <- 'bad'
#   meta.dat$PR4.n <- as.factor(meta.dat$PR4.n)
#   save(cell.count, meta.dat, cell.freq,cell.marker.mean,cell.marker.cvs, cell.marker.median,
#        file = paste0('/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022_09_29/',files[i]))
# }
```

```{r, message=FALSE, message=F, warning=F, echo=FALSE, results='hide'}
##Subset the array data for T cell only or  BTNK cells separately
load('/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022_09_13/Anno.RData')
BTNK <- anno %>% dplyr::filter(compartment %in% c("T Cell", "NK Cell","B Cell"))
Tcell <- anno %>% dplyr::filter(compartment %in% c("T Cell"))
# for(level in c('Compartment','Assignment','Profiling')){
#   tmp <- load(paste0('/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022_09_29/',level,'.RData'))
#   sub.type <- unique(BTNK[,tolower(level)])
#   meta.dat <- meta.dat[!(meta.dat$SubjectID == 'AG498' & meta.dat$TimePoint == 'C1'), ]
#   sam.ids <- rownames(cell.count)[-grep('AG489_C1',rownames(cell.count))]
#   cell.count <- cell.count[sam.ids,, drop =F][,sub.type, drop =F]
#   cell.freq <- cell.count / rowSums(cell.count)
#   cell.freq[is.na(cell.freq)] <- 0
#   cell.marker.mean.sub <- cell.marker.cvs.sub <- cell.marker.median.sub <-
#     array(NA, c(nrow(cell.freq), ncol(cell.freq), length(dimnames(cell.marker.mean)[[3]])),
#           dimnames = list(rownames(cell.freq), colnames(cell.freq), dimnames(cell.marker.mean)[[3]]))
#   for(i in rownames(cell.freq)){
#     cell.marker.mean.sub[i,,] <- cell.marker.mean[i,,][colnames(cell.freq),]
#     cell.marker.median.sub[i,,] <- cell.marker.median[i,,][colnames(cell.freq),]
#     cell.marker.cvs.sub[i,,] <- cell.marker.cvs[i,,][colnames(cell.freq),]
#   }
#   
#   cell.marker.mean <- cell.marker.mean.sub
#   cell.marker.cvs <- cell.marker.cvs.sub
#   cell.marker.median <- cell.marker.median.sub
#   save(cell.count, meta.dat, cell.freq, cell.marker.mean,cell.marker.cvs, cell.marker.median,
#        file = paste0('/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022_09_29/',level,'_BTNK.RData'))
#   
# }



# for(level in c('Compartment','Assignment','Profiling')){
#   tmp <- load(paste0('/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022_09_29/',level,'.RData'))
#   sub.type <- unique(Tcell[,tolower(level)])
#   meta.dat <- meta.dat[!(meta.dat$SubjectID == 'AG498' & meta.dat$TimePoint == 'C1'), ]
#   sam.ids <- rownames(cell.count)[-grep('AG489_C1',rownames(cell.count))]
#   cell.count <- cell.count[sam.ids,, drop =F][,sub.type, drop =F]
#   cell.freq <- cell.count / rowSums(cell.count)
#   cell.freq[is.na(cell.freq)] <- 0
#   cell.marker.mean.sub <- cell.marker.cvs.sub <- cell.marker.median.sub <-
#     array(NA, c(nrow(cell.freq), ncol(cell.freq), length(dimnames(cell.marker.mean)[[3]])),
#           dimnames = list(rownames(cell.freq), colnames(cell.freq), dimnames(cell.marker.mean)[[3]]))
#   for(i in rownames(cell.freq)){
#     cell.marker.mean.sub[i,,] <- cell.marker.mean[i,,][colnames(cell.freq),]
#     cell.marker.median.sub[i,,] <- cell.marker.median[i,,][colnames(cell.freq),]
#     cell.marker.cvs.sub[i,,] <- cell.marker.cvs[i,,][colnames(cell.freq),]
#   }
#   
#   cell.marker.mean <- cell.marker.mean.sub
#   cell.marker.cvs <- cell.marker.cvs.sub
#   cell.marker.median <- cell.marker.median.sub
#   save(cell.count, meta.dat, cell.freq, cell.marker.mean,cell.marker.cvs, cell.marker.median,
#        file = paste0('/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022_09_29/',level,'_Tcell.RData'))
# }
###########################################
```

* Methods for Figure 1ABCD, 2AB (this manuscript used):
    
    - Flow cytometry files were uploaded to the Astrolabe Cytometry Platform (Astrolabe Diagnostics, Inc) where transformation, cleaning (doublets, debris), labeling, and unsupervised clustering were done. Non-transformed data were downloaded and used in the statistical analysis. For differential abundance analysis (DAA), we applied total sum scaling normalization and asinhsqrt transformation to the count data. Then linear model was applied to compare the cell type abundance between bad vs. good response at different time points. For differential expression analysis (DEA), mean marker intensity was summarized per sample within each cell type. Then we calculated the log2 fold change of the mean marker intensity between C1, C3, C4 and baseline, respectively. Linear model was also applied to compare the marker intensity between bad vs. good response at different time points. For both DAA and DEA, a P value of <= 0.05 was considered significant and shown in the plots. Statistical analyses were performed using R software version 4.1.1.


# Figure 1A
```{r echo=F, error=TRUE, fig.height=14, fig.retina=4, fig.width=22, message=FALSE, warning=FALSE, include=T, results="asis"}
root.dir = '/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/'

for(level in c('Assignment')){
  cat('----',level,'--- \n')
  for(type in c('BTNK')){
    cat('----',type,'--- \n')
    load(file.path(root.dir,'Data/2022_09_29', paste0(level, '.RData')))
    meta.dat0 <- meta.dat; cell.count0 <- cell.count
    load(paste0(root.dir,'Data/2022_09_29/', paste0(level, '_',type,'.RData'))) 
    meta.dat$SubjectID <- gsub('WWV54','WVW54',meta.dat$SubjectID)
    ## AG498 has been excluded in this RData
    meta.dat <- meta.dat0; cell.count <- cell.count0[,colnames(cell.count), drop =F]
    # meta2022 <- read.csv("~/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/meta.csv") %>% 
    #   dplyr::filter(!is.na(TimePoint))
    # meta2022$PR2.n <- NA
    # meta2022[meta2022$BRAF == 'BRAFwt' & meta2022$PR4 %in% c('pCR','nc pCR','pPR'),'PR2.n'] <- 'good'
    # meta2022[meta2022$BRAF == 'BRAFwt' & meta2022$PR4 %in% c('pMR'),'PR2.n'] <- 'bad'
    # meta2022[meta2022$BRAF == 'BRAFm' & meta2022$PR4 %in% c('pCR','nc pCR'),'PR2.n'] <- 'good'
    # meta2022[meta2022$BRAF == 'BRAFm' & meta2022$PR4 %in% c('pMR','pPR'),'PR2.n'] <- 'bad'
    # meta.dat1 <- inner_join(meta.dat, meta2022 %>% dplyr::select(name, PR2.n))
    # tm <- load(file.path(root.dir,'Data/2022_09_29', paste0(level, '.RData')))
    # meta.dat <- meta.dat1
    # save(meta.dat, cell.count, cell.freq, cell.marker.mean, cell.marker.cvs, cell.marker.median, file = file.path(root.dir,'Data/2022_09_29', paste0(level, '.RData')))
    cell.freq <- cell.count/rowSums(cell.count)
    # load(paste0(root.dir,'Data/2022_09_29/', paste0(level, '_',type,'.RData')))
    # load(file.path(root.dir,'Data/2022_09_29', paste0(level, '.RData')))
    
    ## filter criterion
    if(level =='Assignment'){
      minp = 0.0;pct = 0
    }else{
      minp = 0.02;pct = 0.4
    }
    
    if(level == "Profiling"){
      ## collapse low abundance celltypes into 'other' group
      ind <- apply(cell.freq, 2, function(x) sum(x>minp) > (nrow(cell.freq) * pct))
      cell.freq1 <- cell.freq[,ind]
      other <- 1- rowSums(cell.freq1)
      cell.freq1 <- merge(cell.freq1, cbind(other), by = 0) %>% column_to_rownames('Row.names')
    }else{
      cell.freq1 <- cell.freq
    }
    
    col.name = 'file_name' ## name for join 2 dfs
    
    if(subsetBRAF ==T){
      meta.sub <- meta.dat %>% dplyr::filter(BRAF == BRAF.sub) %>% 
        dplyr::select(c(col.name,'TimePoint','SubjectID',grp.name)) %>% droplevels() 
    }else{
      meta.sub <- meta.dat %>% 
        dplyr::select(c(col.name,'TimePoint','SubjectID',grp.name)) %>% droplevels() 
    }
    
    plt <- as.data.frame(cbind(cell.freq1[meta.sub[,col.name],,drop =F])) %>% rownames_to_column(col.name) %>% inner_join(meta.sub, by = col.name)
    plt.m <- reshape2::melt(plt)
    
    plt.m$TimePoint <- gsub('BASELINE','base',plt.m$TimePoint)
    plt.m$TimePoint <- factor(plt.m$TimePoint, levels = c('base','C1','C3','C4'))
    plt.m$SubjectID <- gsub('WWV54','WVW54',plt.m$SubjectID)
    
    
    p1 <- ggplot(plt.m %>% dplyr::filter(!!as.name(grp.name)==unique(plt.m[,grp.name])[1]), aes(x = TimePoint, y = value, fill = variable)) +
      geom_bar(stat="identity") +
      facet_grid(. ~ SubjectID, scales = 'free',space = "free") +
      labs(y = paste0(unique(plt.m[,grp.name])[1],'(Proportion)'), x = '') +
      scale_fill_manual(values = c(brewer.pal(9,'Set3'),brewer.pal(9,'Set1'),brewer.pal(8,'Set2'),brewer.pal(8,'Dark2'))) +
      theme_bw() +
      theme(axis.text = element_text(color = 'black', size = 20),
            axis.title = element_text(color = 'black', size = 20),
            strip.text.x = element_text(color = 'black',size = 20),
            legend.text = element_text(color = 'black',size = 20),
            axis.text.x = element_text(color = 'black', angle = 90, size = 20, hjust = 1, vjust = 0.25),
            legend.position = 'bottom',
            legend.title = element_blank())
    
    p2 <- ggplot(plt.m %>% dplyr::filter(!!as.name(grp.name)==unique(plt.m[,grp.name])[2]), aes(x = TimePoint, y = value, fill = variable)) +
      geom_bar(stat="identity") +
      facet_grid(.~SubjectID, scales = 'free',space = "free") +
      # facet_wrap(PR2 ~ SubjectID, nrow = 2,  drop=TRUE) +
      labs(y = paste0(unique(plt.m[,grp.name])[2],'(Proportion)'), x = '') +
      scale_fill_manual(values = c(brewer.pal(9,'Set3'),brewer.pal(9,'Set1'),brewer.pal(8,'Set2'),brewer.pal(8,'Dark2'))) +
      theme_bw() +
      theme(axis.text = element_text(color = 'black', size = 20),
            axis.title = element_text(color = 'black', size = 20),
            strip.text.x = element_text(color = 'black',size = 20),
            legend.text = element_text(color = 'black',size = 20),
            axis.text.x = element_text(color = 'black', angle = 90, size = 20, hjust = 1, vjust = 0.25),
            legend.position = 'bottom',
            legend.title = element_blank())
    pp <- ggarrange(p1, p2, nrow = 2, common.legend = T)
    print(pp)
    # #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure1A_",BRAF.sub,".pdf"), width =20, height = 12)
  }
}
```


```{r, message=FALSE, message=F, warning=F, echo=FALSE, results='hide'}
source(paste0(root.dir,'Code/Stats.R'))
source(paste0(root.dir,'Code/Func.R'))

cell.abund.obj <- cell.prop.obj <- cell.diff.obj <- list()
i = 0
for(level in c('Compartment','Assignment','Profiling')){
  i = i + 1
  output <- paste0(root.dir,'Result/',level)
  load(file.path(root.dir,'Data/2022_09_29', paste0(level, '.RData')))
  meta.dat$SubjectID <- gsub('WWV54','WVW54',meta.dat$SubjectID)
  
  if(subsetBRAF ==T){
    meta.dat <- meta.dat[meta.dat$file_name !="20201028_AG489_C1" & meta.dat$BRAF == BRAF.sub,]
  }else{
    meta.dat <- meta.dat[meta.dat$file_name !="20201028_AG489_C1", ]
  }
  cell.count <- cell.count[meta.dat$file_name,,drop =F]
  cell.freq <- cell.freq[meta.dat$file_name,,drop =F]
  # cell.count <- cell.count[,unique(BTNK[,tolower(level)])]
  ## cell.diff.obj 
  cell.count0 <- cell.count + 0.5
  size.factor <- rowSums(cell.count0)
  cell.freq <- cell.count0 / size.factor
  cell.freq.base <- cell.freq[meta.dat[meta.dat$TimePoint == 'BASELINE','file_name'], ]
  rownames(cell.freq.base) <- gsub("^([^_]*_[^_]*)_.*$", "\\1", rownames(cell.freq.base))
  base.name <- rownames(cell.freq.base)
  cell.freq.diff <- names <- NULL
  for(k in c('BASELINE','C1','C3','C4')){
    cell.time <- cell.freq[meta.dat[meta.dat$TimePoint == k,'file_name'], ]
    names <- c(names, rownames(cell.time))
    rownames(cell.time) <- gsub("^([^_]*_[^_]*)_.*$", "\\1", rownames(cell.time))
    cell.freq.diff <- rbind(cell.freq.diff, cell.time/cell.freq.base[rownames(cell.time),])
  }
  rownames(cell.freq.diff) <- names
  cell.freq.diff <- log2(cell.freq.diff) #log fold change from the baseline
  # cell.freq.diff.sqrt <- sign(cell.freq.diff) * sqrt(abs(cell.freq.diff ))
  
  cell.count.filter <- cell.count[,colSums(cell.count) > 0]
  cell.diff.obj[[paste0('level', i)]] <- cell.freq.diff[,colnames(cell.count.filter)]
  # cell.abund.obj[[paste0('level', i)]] <- cell.count
  cell.abund.obj[[paste0('level', i)]] <- cell.count.filter
  cell.prop.obj[[paste0('level', i)]] <- cell.freq[,colnames(cell.count)] # not filtered , all cells
}
names(cell.abund.obj) <- names(cell.prop.obj) <- names(cell.diff.obj)  <- c('Compartment','Assignment','Profiling')

meta.samples <- meta.dat[,c('file_name','TimePoint','BRAF','PR2','RunDate','patient_id','PR2.n','PR4.n')] %>% dplyr::rename(SubjectID = patient_id)
colnames(meta.samples)[1] <- 'sam.ids'
meta.samples$PR2.n <- as.factor(meta.samples$PR2.n)
meta.samples$PR4.n <- as.factor(meta.samples$PR4.n)
meta.samples <- within(meta.samples, BRAF <- relevel(BRAF, ref = 1))
meta.samples <- within(meta.samples, PR2 <- relevel(PR2, ref = 1))
```


```{r, message=FALSE, message=F, warning=F, echo=FALSE, results='hide'}
## perform differential abundance analysis, save daa.res of different timepoints into one file
run <- function(cell.obj, meta.samples, cell.plot.obj, method, 
                dir.l1, dir.l2 = 'observed',
                cell.levels = c('Compartment','Assignment','Profiling'),
                grp.name, adj.name, timepoints =c('BASELINE','C1','C3','C4') ,BRAF.sub,transform,
                subsetBRAF = F,filter = T, feature.dat.type = 'count',diff = '',labels.y = 'Proportion'){
  for(cell.level in cell.levels){ #
    output <- paste0(dir.l1, dir.l2, '/',cell.level,'/')
    if(!dir.exists(output)){dir.create(output)}
    
    output1 <- paste0(output,'testing',grp.name,'_adj',paste0(adj.name,collapse = '.'),'_subset',subsetBRAF,diff,'/')
    if(!dir.exists(output1)){dir.create(output1)}

    daa <- NULL
    for(time in timepoints){
      if(subsetBRAF == T){
        meta <- meta.samples %>% dplyr::filter(meta.samples$TimePoint == time & meta.samples$BRAF==BRAF.sub)
      }else{
        meta <- meta.samples %>% dplyr::filter(meta.samples$TimePoint == time)
      }
      
      data.obj <- list()
      for(k in names(cell.obj)){
        cell.sub <- cell.obj[[k]]
        data.obj[[k]] <- cell.sub[meta$sam.ids,]
      }
      
      set.seed(123)
      daa.res <- perform_DAA(data.obj = data.obj, meta.samples = meta, cell.level = cell.level,
                             grp.name, adj.name, strata = NULL, method = method, filter= filter,
                             transform = transform,
                             feature.dat.type, cell.depth = 0, output = NULL)
      daa <- rbind(daa, daa.res$res %>% rownames_to_column('cells') %>% dplyr::mutate(time = time))

    }
    save(daa, file = paste0(output1,'daa.res.',method,'.RData')) ## all timepoints daa.res will be saved into one file, for later plotting purpose
    
    # load(paste0(output1,'daa.res.',method, '.RData'))
    if(method == 'LinDA'){
      daa.table <- daa %>% dplyr::select(cells,log2FoldChange, lfcSE,pvalue, padj, time) %>% 
      dplyr::mutate(log2FoldChange = round(log2FoldChange,2), lfcSE = round(lfcSE,2),
             pvalue = round(pvalue,2), padj = round(padj,2)) %>% arrange(pvalue)
    }
    
     if(method == 'lm'){
      daa.table <- daa %>% dplyr::mutate(coef = round(coef,2), sd.err = round(sd.err,2),
             pvalue = pvalue, padj = padj) %>% arrange(pvalue)
    }
    
    col <- c(sig = 'red', ns = 'grey')
    vol.df <- daa %>% dplyr::mutate(label = ifelse(pvalue <= 0.05, 'sig','ns'), log10pval = -log10(pvalue))
    ct <- sum(daa$pvalue<= 0.05)
    pct <- round(ct/nrow(daa) * 100)
    if(method == 'lm'){x.col = 'coef'}
    if(method == 'LinDA'){x.col = 'log2FoldChange'}
    v <- ggplot(vol.df, aes(x = !!as.name(x.col), y = log10pval, color = label)) +
      geom_point(size = 1) +
      scale_color_manual(values = col) +
      labs(y = '-log10P') +
      theme_bw() +
      theme(legend.position = "none",
            axis.text = element_text(size = 16),
            axis.title = element_text(size = 16)) +
      annotate("text", x=0, y=max(vol.df$log10pval) * 0.95, 
               label= paste0(ct, '(',pct, '% tested) markers raw.p <= 0.05 in all timepoints')) 
    daa <- daa %>% dplyr::mutate(pvalue = round(pvalue,2), padj = round(padj,2)) 
    timeplot.rawp <- plot_timeseries_boxplot(cell.plot.obj, meta.samples, daa, 
                                             cell.level=cell.level, grp.name, labels.y = labels.y,
                                             add.smooth =T,
                                             plot.type = 'pointplot', cutoff = 0.2, cutoff.pval = 0.05, 
                                            show.p = 'p', root.dir= NULL)
    timeplot.box <- plot_timeseries_boxplot(cell.plot.obj, meta.samples, daa, 
                                             cell.level=cell.level, grp.name, labels.y = labels.y,
                                             add.smooth =T,
                                             plot.type = 'boxplot', cutoff = 0.2, cutoff.pval = 0.05, 
                                            show.p = 'p', root.dir= NULL)
    timeplot.line <- plot_timeseries_boxplot(cell.plot.obj, meta.samples, daa, 
                                             cell.level=cell.level, grp.name, labels.y = labels.y,
                                             add.smooth =T,
                                             plot.type = 'lineplot', cutoff = 0.2, cutoff.pval = 0.05, 
                                            show.p = 'p', root.dir= NULL)
  }
  return(list(tb = daa, volcano = v, timeplot.rawp = timeplot.rawp, timeplot.box = timeplot.box, timeplot.line = timeplot.line))
}

```

# Figure 1B
```{r, message=FALSE, message=F, warning=F, echo=FALSE, results='hide'}
CD4 <- c("CD4+ T Cell (Central Memory)","CD4+ T Cell (Effector Memory)","CD4+ T Cell (EMRA)","CD4+ T Cell (Naive)")
CD8 <- c("CD8+ T Cell (Central Memory)","CD8+ T Cell (Effector Memory)","CD8+ T Cell (EMRA)","CD8+ T Cell (Naive)")
dir.l1 <- '/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Result/2022_12_14_FinalSummary/DAA/'
### Figure 1B
cell.prop.obj$CD48 <- cbind(`CD4+ T cells`= rowSums(cell.prop.obj$Assignment[,CD4]), 
                            `CD8+ T cells`=rowSums(cell.prop.obj$Assignment[,CD8]),
                            `B cell`= (cell.prop.obj$Compartment[,'B Cell']),
                            `NK cell`= (cell.prop.obj$Compartment[,'NK Cell']),
                            `gd T Cell` =(cell.prop.obj$Assignment[,'gd T Cell']))
ree <- NULL
ree <- run(cell.obj = cell.prop.obj, cell.plot.obj = cell.prop.obj, 
           dir.l1 = dir.l1, dir.l2 = 'mean_observed', 
           cell.levels = 'CD48',timepoints =c('BASELINE','C1','C3','C4'),
           transform = 'asinhsqrt',
           feature.dat.type = 'other', filter = F, method = 'lm', subsetBRAF = subsetBRAF, BRAF.sub = BRAF.sub,
           meta.samples = meta.samples, grp.name = grp.name, adj.name = adj.name)
res <- ree$tb[,c('cells','pvalue','time')] %>% spread(time, pvalue) %>% column_to_rownames('cells')
reactable(res)
res0 <- t(res)
```

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=14, message=FALSE, warning=FALSE, include=T, results="asis"}
plt <- list()
for(celltype in colnames(cell.prop.obj$CD48)){
  data <- as.data.frame(cell.prop.obj$CD48[,c(celltype), drop =F]) %>% rownames_to_column('sam.ids')
  meta.tmp <- meta.samples[,c('sam.ids','TimePoint','PR4.n')]
  colnames(meta.tmp)[3] <- 'Response'
  data1 <- full_join(data, meta.tmp) 
  p <- as.data.frame(res0[,celltype,drop =F])%>% rownames_to_column('TimePoint')
  colnames(p)[2] <- 'p'
  data2 <- data1 %>% left_join(p)
  data2$TimePoint <- paste0(data2$TimePoint, '(p=',data2$p,')')
  data2$Response <- gsub('good',paste0(as.character(expression("\u2264")),10),data2$Response)
  data2$Response <- gsub('bad','>10',data2$Response)
  data2 <- within(data2, Response <- factor(Response, levels = c(paste0(as.character(expression("\u2264")),10),'>10')))
  plt[[celltype]] <- ggplot(data2, aes(y = (!!as.name(celltype))*100, x = Response, color =!!as.name('Response'))) +
    geom_boxplot() +
    geom_jitter(position = position_jitterdodge(0.5)) +
    facet_wrap(~TimePoint, nrow =1) +
    scale_color_manual(values = c("≤10"=brewer.pal(8,'Set1')[2],">10"=brewer.pal(8,'Set1')[1])) +
    theme_bw() +
    theme(axis.title = element_text(size = 14),
          panel.grid = element_blank(),
          strip.text.x = element_text(size = 12),
          axis.text = element_text(size = 12, color = 'black'),
          legend.position = 'none',
          plot.title = element_text(hjust = 0.5)) +
    labs(x = 'Pathologic response (% viable tumor cells)', y = '% of total cells') +
    ggtitle(celltype)
}
pp <- ggarrange(plt$`CD4+ T cells`, plt$`CD8+ T cells`, plt$`B cell`, plt$`NK cell`, plt$`gd T Cell`)
# pp <- ggarrange(plt$`CD4+ T cells`, plt$`CD8+ T cells`, plt$`B cell`, plt$`NK cell`, plt$`gd T Cell`,plt$`CD8+ T Cell (Central Memory)`)
print(pp)
# ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Report/Report_Summary/Folder2/Figure1B_",BRAF.sub,"new.pdf"), width =20, height = 8)
```

# Figure 1C

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=10, message=FALSE, warning=FALSE, include=T, results="asis"}
dir.l1 <- '/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Result/2022_12_14_FinalSummary/DAA/'
ree <- NULL
ree <- run(cell.obj = cell.abund.obj, cell.plot.obj = cell.prop.obj, dir.l1 = dir.l1, dir.l2 = 'mean_observed', 
           cell.levels = 'Assignment',timepoints =c('BASELINE','C1','C3','C4'),
           transform = 'TSS.asinhsqrt',
           feature.dat.type = 'other', filter = F, method = 'lm', subsetBRAF = subsetBRAF, BRAF.sub = BRAF.sub,
           meta.samples = meta.samples, grp.name = grp.name, adj.name = adj.name)
res <- ree$tb[,c('cells','pvalue','time')] %>% spread(time, pvalue) %>% dplyr::filter(cells %in% c(CD4,CD8))%>% column_to_rownames('cells')
reactable(res)
res0 <- t(res)
```

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=10, message=FALSE, warning=FALSE, include=T, results="asis"}
plt <- list()
for(celltype in c(CD4, CD8)){
  data <- as.data.frame(cell.prop.obj$Assignment[,c(celltype), drop =F]) %>% rownames_to_column('sam.ids')
  meta.tmp <- meta.samples[,c('sam.ids','TimePoint','PR4.n')]
  colnames(meta.tmp)[3] <- 'Response'
  data1 <- full_join(data, meta.tmp) 
  p <- as.data.frame(res0[,celltype,drop =F])%>% rownames_to_column('TimePoint')
  colnames(p)[2] <- 'p'
  data2 <- data1 %>% left_join(p)
  data2$TimePoint <- paste0(data2$TimePoint, '(p=',data2$p,')')
    data2$Response <- gsub('good',paste0(as.character(expression("\u2264")),10),data2$Response)
  data2$Response <- gsub('bad','>10',data2$Response)
  data2 <- within(data2, Response <- factor(Response, levels = c(paste0(as.character(expression("\u2264")),10),'>10')))

  plt[[celltype]] <- ggplot(data2, aes(y = (!!as.name(celltype))*100, x = Response, color =!!as.name('Response'))) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(position = position_jitterdodge(0.5)) +
    facet_wrap(~TimePoint, nrow =1) +
    scale_color_manual(values = c("≤10"=brewer.pal(8,'Set1')[2],">10"=brewer.pal(8,'Set1')[1])) +
    theme_bw() +
    theme(axis.title = element_text(size = 14),
          panel.grid = element_blank(),
          strip.text.x = element_text(size = 12),
          axis.text = element_text(size = 12, color = 'black'),
          legend.position = 'none',
          plot.title = element_text(hjust = 0.5)) +
    labs(x = 'Pathologic response (% viable tumor cells)', y = '% of total cells') +
    ggtitle(celltype)
}


pp2<- ggarrange(plt$`CD8+ T Cell (Naive)`, plt$`CD8+ T Cell (Central Memory)`, plt$`CD8+ T Cell (Effector Memory)`, plt$`CD8+ T Cell (EMRA)`)
print(pp2)
##ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure1C_",BRAF.sub,".pdf"), width =12, height = 8)
```

# Figure 1D

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=10, message=FALSE, warning=FALSE, include=T, results="asis"}
pp1 <- ggarrange(plt$`CD4+ T Cell (Naive)`, plt$`CD4+ T Cell (Central Memory)`, plt$`CD4+ T Cell (Effector Memory)`, plt$`CD4+ T Cell (EMRA)`)
print(pp1)
#ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure1D_",BRAF.sub,".pdf"), width =12, height = 8)
```

# Figure2AB

* This part shows results of:

    - differential expression analysis(DEA) of marker expression within CD8+ T cell, CD4+ T cell, CD8+ T Cell (Central Memory) and CD4+ T Cell (Effector Memory).

* Tables show raw P-value of DEA, followed by boxplots.


## 1.Within all samples
```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
###-------------------- DEA --------------
## exclude outlier sample
level = 'Assignment'
tmp <- load(paste0("/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022/agg_trans/",level,".RData"))
meta.dat$SubjectID <- gsub('WWV54','WVW54',meta.dat$SubjectID)

if(subsetBRAF == T){
  meta.samples <- meta.samples[meta.samples$sam.ids != "20201028_AG489_C1" & meta.samples$BRAF == BRAF.sub,,drop =F]
}else{
  meta.samples <- meta.samples[meta.samples$sam.ids != "20201028_AG489_C1" ,,drop =F]
}

files <- meta.samples$sam.ids
cell.marker.mean0 <- cell.marker.cvs0 <- cell.marker.median0 <- cell.marker.90qt0 <- cell.marker.99qt0 <- 
  array(NA, c(length(files), length(dimnames(cell.marker.mean)[[2]]), length(dimnames(cell.marker.mean)[[3]])), 
        dimnames = list(files, dimnames(cell.marker.mean)[[2]],dimnames(cell.marker.mean)[[3]]))
for(file in files){
  cell.marker.mean0[file,,] <- cell.marker.mean[file,,] 
  cell.marker.median0[file,,] <- cell.marker.median[file,,] 
  cell.marker.cvs0[file,,] <- cell.marker.cvs[file,,] 
  cell.marker.90qt0[file,,] <- cell.marker.90qt[file,,] 
  cell.marker.99qt0[file,,] <- cell.marker.99qt[file,,] 
}

cell.marker.mean <- cell.marker.mean0
cell.marker.median <- cell.marker.median0
cell.marker.90qt <- cell.marker.90qt0
cell.marker.99qt <- cell.marker.99qt0


### log fold change from baseline
lfc.func <- function(cell.marker){
  base <- cell.marker[meta.samples[meta.samples$TimePoint == 'BASELINE','sam.ids'], , ]
  base.name <- dimnames(base)[[1]]
  base.name <- sub("^(.*?_.*?)_.*", "\\1", base.name)
  
  cell.marker.base <- cell.marker
  for (timepoint in levels(meta.dat$TimePoint)) {
    time.name <- dimnames(cell.marker[meta.samples[meta.samples$TimePoint == timepoint,'sam.ids'], , ])[[1]]
    time.name <- sub("^(.*?_.*?)_.*", "\\1", time.name)
    ind <- base.name %in% time.name
    base0 <- base[ind,,]
    cell.marker.base[meta.samples[meta.samples$TimePoint == timepoint,'sam.ids'], , ] <- base0
  }
  
  cell.marker.diff <- (cell.marker - cell.marker.base)
  cell.marker.diff.sqrt <- sign(cell.marker.diff) * (sqrt(abs(cell.marker.diff)))
  
  cell.marker.fc <- cell.marker / cell.marker.base
  # baseline has some 0s, thus we replace 0 with min
  zeros <- cell.marker.fc[sapply(cell.marker.fc, function(x) (!is.na(x)) & x ==0)]
  rep.min <- min(cell.marker.fc[!is.na(cell.marker.fc) & cell.marker.fc > 0])
  if(length(zeros)>0){
    cell.marker.fc[sapply(cell.marker.fc, function(x) (!is.na(x)) & x ==0)] <- rep.min
  }
  cell.marker.lfc <- log2(cell.marker.fc)
  return(list(cell.marker.lfc = cell.marker.lfc, cell.marker.diff.sqrt = cell.marker.diff.sqrt))
}

# lfc.func <- function(cell.marker){
#   base <- cell.marker[meta.samples[meta.samples$TimePoint == 'BASELINE','sam.ids'], , ]
#   base.name <- dimnames(base)[[1]]
#   base.name <- sub("^(.*?_.*?)_.*", "\\1", base.name)
#   
#   cell.marker.base <- cell.marker
#   for (timepoint in levels(meta.dat$TimePoint)) {
#     time.name <- dimnames(cell.marker[meta.samples[meta.samples$TimePoint == timepoint,'sam.ids'], , ])[[1]]
#     time.name <- sub("^(.*?_.*?)_.*", "\\1", time.name)
#     ind <- base.name %in% time.name
#     base0 <- base[ind,,]
#     cell.marker.base[meta.samples[meta.samples$TimePoint == timepoint,'sam.ids'], , ] <- base0
#   }
#   
#   cell.marker.diff <- (cell.marker - cell.marker.base)
#   cell.marker.diff.sqrt <- sign(cell.marker.diff) * (sqrt(abs(cell.marker.diff)))
#   
#   cell.marker.fc <- (cell.marker+0.5) / (cell.marker.base+0.5)
#   # baseline has some 0s, thus we replace 0 with min
#   # zeros <- cell.marker.fc[sapply(cell.marker.fc, function(x) (!is.na(x)) & x ==0)]
#   # rep.min <- min(cell.marker.fc[!is.na(cell.marker.fc) & cell.marker.fc > 0])
#   # if(length(zeros)>0){
#   #   cell.marker.fc[sapply(cell.marker.fc, function(x) (!is.na(x)) & x ==0)] <- rep.min
#   # }
#   cell.marker.lfc <- log2(cell.marker.fc)
#   return(list(cell.marker.lfc = cell.marker.lfc, cell.marker.diff.sqrt = cell.marker.diff.sqrt))
# }

cell.marker.90qt.lfc <- lfc.func(cell.marker = cell.marker.90qt)$cell.marker.lfc
cell.marker.90qt.diff.sqrt <- lfc.func(cell.marker = cell.marker.90qt)$cell.marker.diff.sqrt
cell.marker.mean.lfc <- lfc.func(cell.marker = cell.marker.mean)$cell.marker.lfc


## aggregate CD4+ or CD8+ cells 
level = 'Assignment'
tmp <- load(paste0("/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022/agg_trans/",level,".RData"))
meta.dat$SubjectID <- gsub('WWV54','WVW54',meta.dat$SubjectID)

if(subsetBRAF == T){
  meta.samples <- meta.samples[meta.samples$sam.ids != "20201028_AG489_C1" & meta.samples$BRAF == BRAF.sub,,drop =F]
}else{
  meta.samples <- meta.samples[meta.samples$sam.ids != "20201028_AG489_C1" ,,drop =F]
}

files <- meta.samples$sam.ids
celltypes.CD4 <- unique(BTNK[,tolower(level)])[grep('^CD4\\+\\ T',unique(BTNK[,tolower(level)]))]
celltypes.CD8 <- unique(BTNK[,tolower(level)])[grep('^CD8\\+\\ T',unique(BTNK[,tolower(level)]))]

cell.marker.mean1 <- cell.marker.cvs1 <- cell.marker.median1 <- cell.marker.90qt1 <- cell.marker.99qt1 <- 
  array(NA, c(length(files), 2, length(dimnames(cell.marker.mean)[[3]])), 
        dimnames = list(files, c('CD4+','CD8+'),dimnames(cell.marker.mean)[[3]]))
for(file in files){
  tmp1 <- as.data.frame(cell.marker.mean[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  tmp2 <- as.data.frame(cell.marker.median[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  tmp3 <- as.data.frame(cell.marker.cvs[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  tmp4 <- as.data.frame(cell.marker.90qt[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  tmp5 <- as.data.frame(cell.marker.99qt[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  cell.marker.mean1[file,,] <- tmp1
  cell.marker.median1[file,,] <- tmp2
  cell.marker.cvs1[file,,] <- tmp3
  cell.marker.90qt1[file,,] <- tmp4
  cell.marker.99qt1[file,,] <- tmp5
}

cell.marker.mean.agg <- cell.marker.mean1
cell.marker.median.agg <- cell.marker.median1
cell.marker.90qt.agg <- cell.marker.90qt1
cell.marker.99qt.agg <- cell.marker.99qt1


cell.marker.90qt.agg.lfc <- lfc.func(cell.marker = cell.marker.90qt.agg)$cell.marker.lfc
cell.marker.90qt.agg.diff.sqrt <- lfc.func(cell.marker = cell.marker.90qt.agg)$cell.marker.diff.sqrt
cell.marker.mean.agg.lfc <- lfc.func(cell.marker = cell.marker.mean.agg)$cell.marker.lfc

dea2tb <- function(dea.res1){
  df1 = list_df(dea.res = dea.res1, list.name = 'raw.p') %>% 
    dplyr::mutate(type = 'raw.p') %>% dplyr::select(-variables)
  df2 = list_df(dea.res = dea.res1, list.name = 'result') %>% 
    dplyr::mutate(type = 'fdr') %>% dplyr::select(-variables)
  df3 = list_df(dea.res = dea.res1, list.name = 'coefs') %>% 
    dplyr::mutate(type = 'coef') %>% dplyr::select(-variables)
  df4 = list_df(dea.res = dea.res1, list.name = 'sd.errs') %>% 
    dplyr::mutate(type = 'sd.err') %>% dplyr::select(-variables)
  df <- rbind(df1, df2, df3, df4) %>% spread(type, value) %>% na.omit() %>% 
    dplyr::mutate(coef = round(coef,2), fdr = fdr, raw.p = raw.p, sd.err = round(sd.err,2))%>% 
    arrange(raw.p)
  
  tb0 <- df %>% dplyr::mutate(cm = paste0(celltypes,':',markers)) %>% 
    dplyr::select(cm,TimePoints, fdr) %>% spread(TimePoints, fdr) 
  colnames(tb0)[!(colnames(tb0) %in% c('cm'))] <- paste0(colnames(tb0)[!(colnames(tb0) %in% c('cm'))],'(q)')
  
  tb1 <- df %>% dplyr::mutate(cm = paste0(celltypes,':',markers)) %>% 
    dplyr::select(cm,TimePoints, raw.p) %>% spread(TimePoints, raw.p) 
  colnames(tb1)[!(colnames(tb1) %in% c('cm'))] <- paste0(colnames(tb1)[!(colnames(tb1) %in% c('cm'))],'(p)')
  
  tb2 <- df %>% dplyr::mutate( cm = paste0(celltypes,':',markers)) %>% 
    dplyr::select(cm,TimePoints, coef) %>% spread(TimePoints, coef) 
  colnames(tb2)[!(colnames(tb2) %in% c('cm'))] <- paste0(colnames(tb2)[!(colnames(tb2) %in% c('cm'))],'(est)')
  
  tb <- inner_join(tb1, tb0) %>% inner_join(tb2) %>%
    dplyr::mutate(celltypes = gsub('\\:.*','',cm), markers = gsub('.*\\:','',cm)) %>% 
    dplyr::select(-cm)
  tb <- tb %>% dplyr::select(c('celltypes','markers',sort(colnames(.))[!(colnames(.) %in% c('celltypes','markers'))])) %>% 
    mutate_if(is.numeric, function(x) round(x, 2))
  
  return(list(tb=tb, df=df))
}



data_summary <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,varname)
  data_sum <- rename(data_sum, c("mean" = varname))
  return(data_sum)
}
```

### DEA:CD8+ T cell

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
## Within CD8+ Tcells, how marker changes(log2FC data)
celltypes <- c("CD4+","CD8+")
dea.res1 <- NULL
dea.res1 <- perform_DEA_CyTOF(data = cell.marker.mean.agg.lfc, celltypes = celltypes, 
                              sam.col = 'sam.ids', method = 'lm',transform = NULL,
                              BRAF.sub =BRAF.sub, subsetBRAF = subsetBRAF,
                              meta.dat = meta.samples, timepoints = c('C1','C3','C4'), 
                              variables = grp.name,adj.name = adj.name)
tb <- dea2tb(dea.res1)
res <- tb$tb[,c(1:2,4,7,10)]
reactable(res[res$celltypes %in% 'CD8+',], pageSizeOptions = 10, pagination = T, filterable = TRUE,
          columns = list(celltypes = colDef(minWidth = 300), markers = colDef(minWidth = 200)))
# write.csv(res, file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/CD8+Tcell_[mean]DEA_",BRAF.sub,".csv"), row.names = F)
```

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
sub.class = 'CD8+'
CD8.df <- cell.marker.mean.agg.lfc[,sub.class,]
plt <- plt1 <- list()
markers <- c("CTLA-4", "PD-1","PD-L1",'TIGIT','Tim-3','LAG-3')
for(marker in markers){
  plt.df <- full_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                      meta.samples[,c('sam.ids','PR4.n','TimePoint')]) %>% dplyr::filter(TimePoint!='BASELINE')
  colnames(plt.df)[2] <- 'marker'
  colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
  plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
  plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
    geom_line() +
    geom_point()+
    geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  CD8.tmp <- res[res$celltypes==sub.class,]
  colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
  rownames(CD8.tmp) <- NULL
  CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
  colnames(CD8.tmp)[2] <- 'p'
  plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
  plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
    geom_boxplot() + 
    geom_jitter(position = position_jitterdodge(0.5)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  
}
# ggarrange(plt$`CTLA-4`, plt$`PD-1`, plt$`PD-L1`, plt$TIGIT, plt$`Tim-3`, plt$`LAG-3`, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2A_",BRAF.sub,".pdf"), 
#        width = 12, height = 8)
pp <- ggarrange(plt1$`CTLA-4`, plt1$`PD-1`, plt1$`PD-L1`, plt1$TIGIT, plt1$`Tim-3`, plt1$`LAG-3`, common.legend = T)
print(pp)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2A_",BRAF.sub,"_boxplot.pdf"), 
#        width = 12, height = 8)
```

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
plt <- plt1 <- list()
markers <- c("CX3CR1", "CD161")
for(marker in markers){
  plt.df <- full_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                      meta.samples[,c('sam.ids','PR4.n','TimePoint')]) %>% dplyr::filter(TimePoint!='BASELINE')
  colnames(plt.df)[2] <- 'marker'
  colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
  plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
  plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
    geom_line() +
    geom_point()+
    geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  CD8.tmp <- res[res$celltypes=='CD8+',]
  colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
  rownames(CD8.tmp) <- NULL
  CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
  colnames(CD8.tmp)[2] <- 'p'
  plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
  plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
    geom_boxplot() + 
    geom_jitter(position = position_jitterdodge(0.5)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  
}
# ggarrange(plt$CX3CR1,plt$CD161, common.legend = T)
#ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2B_",BRAF.sub,".pdf"),width = 12, height = 4)
pp <- ggarrange(plt1$CX3CR1,plt1$CD161, common.legend = T)
print(pp)
#ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2B_",BRAF.sub,"_boxplot.pdf"), width = 8, height = 4)
```


### DEA:CD4+ T cell
```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
reactable(res[res$celltypes %in% 'CD4+',], pageSizeOptions = 10, pagination = T, filterable = TRUE,
          columns = list(celltypes = colDef(minWidth = 300), markers = colDef(minWidth = 200)))
sub.class = 'CD4+'
CD8.df <- cell.marker.mean.agg.lfc[,sub.class,]
plt <- plt1 <- list()
markers <- c("CTLA-4", "PD-1","PD-L1",'TIGIT','Tim-3','LAG-3')
for(marker in markers){
  plt.df <- full_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                      meta.samples[,c('sam.ids','PR4.n','TimePoint')]) %>% dplyr::filter(TimePoint!='BASELINE')
  colnames(plt.df)[2] <- 'marker'
  colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
  plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
  plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
    geom_line() +
    geom_point()+
    geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  CD8.tmp <- res[res$celltypes==sub.class,]
  colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
  rownames(CD8.tmp) <- NULL
  CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
  colnames(CD8.tmp)[2] <- 'p'
  plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
  plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
    geom_boxplot() + 
    geom_jitter(position = position_jitterdodge(0.5)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  
}
# ggarrange(plt$`CTLA-4`, plt$`PD-1`, plt$`PD-L1`, plt$TIGIT, plt$`Tim-3`, plt$`LAG-3`, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2A_",BRAF.sub,"_CD4.pdf"), 
#        width = 12, height = 8)
pp <- ggarrange(plt1$`CTLA-4`, plt1$`PD-1`, plt1$`PD-L1`, plt1$TIGIT, plt1$`Tim-3`, plt1$`LAG-3`, common.legend = T)
print(pp)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2A_",BRAF.sub,"_CD4_boxplot.pdf"), 
#        width = 12, height = 8)
```

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
plt <- plt1 <- list()
markers <- c("CX3CR1", "CD161")
for(marker in markers){
  plt.df <- full_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                      meta.samples[,c('sam.ids','PR4.n','TimePoint')]) %>% dplyr::filter(TimePoint!='BASELINE')
  colnames(plt.df)[2] <- 'marker'
  colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
  plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
  plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
    geom_line() +
    geom_point()+
    geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  CD8.tmp <- res[res$celltypes==sub.class,]
  colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
  rownames(CD8.tmp) <- NULL
  CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
  colnames(CD8.tmp)[2] <- 'p'
  plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
  plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
    geom_boxplot() + 
    geom_jitter(position = position_jitterdodge(0.5)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
}
# ggarrange(plt$CX3CR1,plt$CD161, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2B_",BRAF.sub,"_CD4.pdf"), 
#        width = 8, height = 4)
pp <- ggarrange(plt1$CX3CR1,plt1$CD161, common.legend = T)
print(pp)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2B_",BRAF.sub,"_CD4_boxplot.pdf"), 
#        width = 8, height = 4)
```




### DEA:CD8+ T Cell (Central Memory)

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
## Figure2A&B
celltypes <- c("CD4+ T Cell (Effector Memory)","CD8+ T Cell (Central Memory)")
dea.res1 <- NULL
dea.res1 <- perform_DEA_CyTOF(data = cell.marker.mean.lfc, celltypes = celltypes, 
                              sam.col = 'sam.ids', method = 'lm',transform = NULL,
                              BRAF.sub =BRAF.sub, subsetBRAF = subsetBRAF,
                              meta.dat = meta.samples, timepoints = c('C1','C3','C4'), 
                              variables = grp.name,adj.name = adj.name)
tb <- dea2tb(dea.res1)
res <- tb$tb[,c(1:2,4,7,10)] 
res$group <- 'CD8+ T cell'
res[res$celltypes %in% res$celltypes[grep('^CD4',res$celltypes)],'group'] <- 'CD4+ T cell'
# write.csv(res, file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/CD8+TCM_CD4TEM_baseline[mean]DEA_",BRAF.sub,".csv"), row.names = F)
reactable(res[res$celltypes=="CD8+ T Cell (Central Memory)",], pageSizeOptions = 10, pagination = T, filterable = TRUE,
          columns = list(celltypes = colDef(minWidth = 300), markers = colDef(minWidth = 200)))
```


```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
CD8.df <- cell.marker.mean.lfc[,"CD8+ T Cell (Central Memory)",]
plt <- plt1 <- list()
markers <- c("CTLA-4", "PD-1","PD-L1",'TIGIT','Tim-3','LAG-3')
for(marker in markers){
  plt.df <- full_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                      meta.samples[,c('sam.ids','PR4.n','TimePoint')]) %>% dplyr::filter(TimePoint!='BASELINE')
  colnames(plt.df)[2] <- 'marker'
  colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
  plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
  plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
    geom_line() +
    geom_point()+
    geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  CD8.tmp <- res[res$celltypes=="CD8+ T Cell (Central Memory)",] %>% dplyr::select(-'group')
  colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
  rownames(CD8.tmp) <- NULL
  CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
  colnames(CD8.tmp)[2] <- 'p'
  plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
  plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
    geom_boxplot() + 
    geom_jitter(position = position_jitterdodge(0.5)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  
}
# ggarrange(plt$`CTLA-4`, plt$`PD-1`, plt$`PD-L1`, plt$TIGIT, plt$`Tim-3`, plt$`LAG-3`, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2A_CD8TCM_",BRAF.sub,".pdf"), 
#        width = 12, height = 8)
pp <- ggarrange(plt1$`CTLA-4`, plt1$`PD-1`, plt1$`PD-L1`, plt1$TIGIT, plt1$`Tim-3`, plt1$`LAG-3`, common.legend = T)
print(pp)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2A_CD8TCM_",BRAF.sub,"_boxplot.pdf"), width = 12, height = 8)
```


```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
plt <- plt1 <- list()
markers <- c("CX3CR1", "CD161")
for(marker in markers){
  plt.df <- full_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                      meta.samples[,c('sam.ids','PR4.n','TimePoint')]) %>% dplyr::filter(TimePoint!='BASELINE')
  colnames(plt.df)[2] <- 'marker'
  colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
  plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
  plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
    geom_line() +
    geom_point()+
    geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  CD8.tmp <- res[res$celltypes=="CD8+ T Cell (Central Memory)",] %>% dplyr::select(-'group')
  colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
  rownames(CD8.tmp) <- NULL
  CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
  colnames(CD8.tmp)[2] <- 'p'
  plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
  plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
    geom_boxplot() + 
    geom_jitter(position = position_jitterdodge(0.5)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  
}
# ggarrange(plt$CX3CR1,plt$CD161, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2B_CD8TCM_",BRAF.sub,".pdf"), 
#        width = 8, height = 4)
pp <- ggarrange(plt1$CX3CR1,plt1$CD161, common.legend = T)
print(pp)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2B_CD8TCM_",BRAF.sub,"_boxplot.pdf"), width = 8, height = 4)
```


### DEA:CD4+ T Cell (Effector Memory)

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=10, message=FALSE, warning=FALSE, include=T, results="asis"}
reactable(res[res$celltypes=="CD4+ T Cell (Effector Memory)",], pageSizeOptions = 10, pagination = T, filterable = TRUE,
          columns = list(celltypes = colDef(minWidth = 300), markers = colDef(minWidth = 200)))
CD4.df <- cell.marker.mean.lfc[,"CD4+ T Cell (Effector Memory)",]
plt <- plt1 <- list()
markers <- c("CTLA-4", "PD-1","PD-L1",'TIGIT','Tim-3','LAG-3')
for(marker in markers){
  plt.df <- full_join(as.data.frame(CD4.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                      meta.samples[,c('sam.ids','PR4.n','TimePoint')]) %>% dplyr::filter(TimePoint!='BASELINE')
  colnames(plt.df)[2] <- 'marker'
  colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
  plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
  plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
    geom_line() +
    geom_point()+
    geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  CD8.tmp <- res[res$celltypes=="CD4+ T Cell (Effector Memory)",] %>% dplyr::select(-'group')
  colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
  rownames(CD8.tmp) <- NULL
  CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
  colnames(CD8.tmp)[2] <- 'p'
  plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
  plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
    geom_boxplot() + 
    geom_jitter(position = position_jitterdodge(0.5)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  
}
# ggarrange(plt$`CTLA-4`, plt$`PD-1`, plt$`PD-L1`, plt$TIGIT, plt$`Tim-3`, plt$`LAG-3`, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2A_CD4TEM_",BRAF.sub,".pdf"), 
#        width = 12, height = 8)
ggarrange(plt1$`CTLA-4`, plt1$`PD-1`, plt1$`PD-L1`, plt1$TIGIT, plt1$`Tim-3`, plt1$`LAG-3`, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2A_CD4TEM_",BRAF.sub,"_boxplot.pdf"), 
#        width = 12, height = 8)
```

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
plt <- plt1 <- list()
markers <- c("CX3CR1", "CD161")
for(marker in markers){
  plt.df <- full_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                      meta.samples[,c('sam.ids','PR4.n','TimePoint')]) %>% dplyr::filter(TimePoint!='BASELINE')
  colnames(plt.df)[2] <- 'marker'
  colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
  plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
  plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
    geom_line() +
    geom_point()+
    geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  CD8.tmp <- res[res$celltypes=="CD4+ T Cell (Effector Memory)",] %>% dplyr::select(-'group')
  colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
  rownames(CD8.tmp) <- NULL
  CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
  colnames(CD8.tmp)[2] <- 'p'
  plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
  plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
    geom_boxplot() + 
    geom_jitter(position = position_jitterdodge(0.5)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  
}
# ggarrange(plt$CX3CR1,plt$CD161, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2B_CD4TEM_",BRAF.sub,".pdf"), 
#        width = 8, height = 4)
pp <- ggarrange(plt1$CX3CR1,plt1$CD161, common.legend = T)
print(pp)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2B_CD4TEM_",BRAF.sub,"_boxplot.pdf"), width = 8, height = 4)
```








## 2.Within BRAFwt

```{r, message=FALSE, message=F, warning=F, echo=FALSE, results='hide'}
grp.name= 'PR4.n'
adj.name= NULL
subsetBRAF= TRUE
BRAF.sub='BRAFwt'
```

```{r, message=FALSE, message=F, warning=F, echo=FALSE, results='hide'}
source(paste0(root.dir,'Code/Stats.R'))
source(paste0(root.dir,'Code/Func.R'))

cell.abund.obj <- cell.prop.obj <- cell.diff.obj <- list()
i = 0
for(level in c('Compartment','Assignment','Profiling')){
  i = i + 1
  output <- paste0(root.dir,'Result/',level)
  load(file.path(root.dir,'Data/2022_09_29', paste0(level, '.RData')))
  meta.dat$SubjectID <- gsub('WWV54','WVW54',meta.dat$SubjectID)
  
  if(subsetBRAF ==T){
    meta.dat <- meta.dat[meta.dat$file_name !="20201028_AG489_C1" & meta.dat$BRAF == BRAF.sub,]
  }else{
    meta.dat <- meta.dat[meta.dat$file_name !="20201028_AG489_C1", ]
  }
  cell.count <- cell.count[meta.dat$file_name,,drop =F]
  cell.freq <- cell.freq[meta.dat$file_name,,drop =F]
  # cell.count <- cell.count[,unique(BTNK[,tolower(level)])]
  ## cell.diff.obj 
  cell.count0 <- cell.count + 0.5
  size.factor <- rowSums(cell.count0)
  cell.freq <- cell.count0 / size.factor
  cell.freq.base <- cell.freq[meta.dat[meta.dat$TimePoint == 'BASELINE','file_name'], ]
  rownames(cell.freq.base) <- gsub("^([^_]*_[^_]*)_.*$", "\\1", rownames(cell.freq.base))
  base.name <- rownames(cell.freq.base)
  cell.freq.diff <- names <- NULL
  for(k in c('BASELINE','C1','C3','C4')){
    cell.time <- cell.freq[meta.dat[meta.dat$TimePoint == k,'file_name'], ]
    names <- c(names, rownames(cell.time))
    rownames(cell.time) <- gsub("^([^_]*_[^_]*)_.*$", "\\1", rownames(cell.time))
    cell.freq.diff <- rbind(cell.freq.diff, cell.time/cell.freq.base[rownames(cell.time),])
  }
  rownames(cell.freq.diff) <- names
  cell.freq.diff <- log2(cell.freq.diff) #log fold change from the baseline
  # cell.freq.diff.sqrt <- sign(cell.freq.diff) * sqrt(abs(cell.freq.diff ))
  
  cell.count.filter <- cell.count[,colSums(cell.count) > 0]
  cell.diff.obj[[paste0('level', i)]] <- cell.freq.diff[,colnames(cell.count.filter)]
  # cell.abund.obj[[paste0('level', i)]] <- cell.count
  cell.abund.obj[[paste0('level', i)]] <- cell.count.filter
  cell.prop.obj[[paste0('level', i)]] <- cell.freq[,colnames(cell.count)] # not filtered , all cells
}
names(cell.abund.obj) <- names(cell.prop.obj) <- names(cell.diff.obj)  <- c('Compartment','Assignment','Profiling')

meta.samples <- meta.dat[,c('file_name','TimePoint','BRAF','PR2','RunDate','patient_id','PR2.n','PR4.n')] %>% dplyr::rename(SubjectID = patient_id)
colnames(meta.samples)[1] <- 'sam.ids'
meta.samples$PR2.n <- as.factor(meta.samples$PR2.n)
meta.samples$PR4.n <- as.factor(meta.samples$PR4.n)
meta.samples <- within(meta.samples, BRAF <- relevel(BRAF, ref = 1))
meta.samples <- within(meta.samples, PR2 <- relevel(PR2, ref = 1))
```

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
###-------------------- DEA --------------
## exclude outlier sample
level = 'Assignment'
tmp <- load(paste0("/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022/agg_trans/",level,".RData"))
meta.dat$SubjectID <- gsub('WWV54','WVW54',meta.dat$SubjectID)

if(subsetBRAF == T){
  meta.samples <- meta.samples[meta.samples$sam.ids != "20201028_AG489_C1" & meta.samples$BRAF == BRAF.sub,,drop =F]
}else{
  meta.samples <- meta.samples[meta.samples$sam.ids != "20201028_AG489_C1" ,,drop =F]
}

files <- meta.samples$sam.ids
cell.marker.mean0 <- cell.marker.cvs0 <- cell.marker.median0 <- cell.marker.90qt0 <- cell.marker.99qt0 <- 
  array(NA, c(length(files), length(dimnames(cell.marker.mean)[[2]]), length(dimnames(cell.marker.mean)[[3]])), 
        dimnames = list(files, dimnames(cell.marker.mean)[[2]],dimnames(cell.marker.mean)[[3]]))
for(file in files){
  cell.marker.mean0[file,,] <- cell.marker.mean[file,,] 
  cell.marker.median0[file,,] <- cell.marker.median[file,,] 
  cell.marker.cvs0[file,,] <- cell.marker.cvs[file,,] 
  cell.marker.90qt0[file,,] <- cell.marker.90qt[file,,] 
  cell.marker.99qt0[file,,] <- cell.marker.99qt[file,,] 
}

cell.marker.mean <- cell.marker.mean0
cell.marker.median <- cell.marker.median0
cell.marker.90qt <- cell.marker.90qt0
cell.marker.99qt <- cell.marker.99qt0


cell.marker.90qt.lfc <- lfc.func(cell.marker = cell.marker.90qt)$cell.marker.lfc
cell.marker.90qt.diff.sqrt <- lfc.func(cell.marker = cell.marker.90qt)$cell.marker.diff.sqrt
cell.marker.mean.lfc <- lfc.func(cell.marker = cell.marker.mean)$cell.marker.lfc


## aggregate CD4+ or CD8+ cells 
level = 'Assignment'
tmp <- load(paste0("/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022/agg_trans/",level,".RData"))
meta.dat$SubjectID <- gsub('WWV54','WVW54',meta.dat$SubjectID)

if(subsetBRAF == T){
  meta.samples <- meta.samples[meta.samples$sam.ids != "20201028_AG489_C1" & meta.samples$BRAF == BRAF.sub,,drop =F]
}else{
  meta.samples <- meta.samples[meta.samples$sam.ids != "20201028_AG489_C1" ,,drop =F]
}

files <- meta.samples$sam.ids
celltypes.CD4 <- unique(BTNK[,tolower(level)])[grep('^CD4\\+\\ T',unique(BTNK[,tolower(level)]))]
celltypes.CD8 <- unique(BTNK[,tolower(level)])[grep('^CD8\\+\\ T',unique(BTNK[,tolower(level)]))]

cell.marker.mean1 <- cell.marker.cvs1 <- cell.marker.median1 <- cell.marker.90qt1 <- cell.marker.99qt1 <- 
  array(NA, c(length(files), 2, length(dimnames(cell.marker.mean)[[3]])), 
        dimnames = list(files, c('CD4+','CD8+'),dimnames(cell.marker.mean)[[3]]))
for(file in files){
  tmp1 <- as.data.frame(cell.marker.mean[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  tmp2 <- as.data.frame(cell.marker.median[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  tmp3 <- as.data.frame(cell.marker.cvs[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  tmp4 <- as.data.frame(cell.marker.90qt[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  tmp5 <- as.data.frame(cell.marker.99qt[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  cell.marker.mean1[file,,] <- tmp1
  cell.marker.median1[file,,] <- tmp2
  cell.marker.cvs1[file,,] <- tmp3
  cell.marker.90qt1[file,,] <- tmp4
  cell.marker.99qt1[file,,] <- tmp5
}

cell.marker.mean.agg <- cell.marker.mean1
cell.marker.median.agg <- cell.marker.median1
cell.marker.90qt.agg <- cell.marker.90qt1
cell.marker.99qt.agg <- cell.marker.99qt1


cell.marker.90qt.agg.lfc <- lfc.func(cell.marker = cell.marker.90qt.agg)$cell.marker.lfc
cell.marker.90qt.agg.diff.sqrt <- lfc.func(cell.marker = cell.marker.90qt.agg)$cell.marker.diff.sqrt
cell.marker.mean.agg.lfc <- lfc.func(cell.marker = cell.marker.mean.agg)$cell.marker.lfc

dea2tb <- function(dea.res1){
  df1 = list_df(dea.res = dea.res1, list.name = 'raw.p') %>% 
    dplyr::mutate(type = 'raw.p') %>% dplyr::select(-variables)
  df2 = list_df(dea.res = dea.res1, list.name = 'result') %>% 
    dplyr::mutate(type = 'fdr') %>% dplyr::select(-variables)
  df3 = list_df(dea.res = dea.res1, list.name = 'coefs') %>% 
    dplyr::mutate(type = 'coef') %>% dplyr::select(-variables)
  df4 = list_df(dea.res = dea.res1, list.name = 'sd.errs') %>% 
    dplyr::mutate(type = 'sd.err') %>% dplyr::select(-variables)
  df <- rbind(df1, df2, df3, df4) %>% spread(type, value) %>% na.omit() %>% 
    dplyr::mutate(coef = round(coef,2), fdr = fdr, raw.p = raw.p, sd.err = round(sd.err,2))%>% 
    arrange(raw.p)
  
  tb0 <- df %>% dplyr::mutate(cm = paste0(celltypes,':',markers)) %>% 
    dplyr::select(cm,TimePoints, fdr) %>% spread(TimePoints, fdr) 
  colnames(tb0)[!(colnames(tb0) %in% c('cm'))] <- paste0(colnames(tb0)[!(colnames(tb0) %in% c('cm'))],'(q)')
  
  tb1 <- df %>% dplyr::mutate(cm = paste0(celltypes,':',markers)) %>% 
    dplyr::select(cm,TimePoints, raw.p) %>% spread(TimePoints, raw.p) 
  colnames(tb1)[!(colnames(tb1) %in% c('cm'))] <- paste0(colnames(tb1)[!(colnames(tb1) %in% c('cm'))],'(p)')
  
  tb2 <- df %>% dplyr::mutate( cm = paste0(celltypes,':',markers)) %>% 
    dplyr::select(cm,TimePoints, coef) %>% spread(TimePoints, coef) 
  colnames(tb2)[!(colnames(tb2) %in% c('cm'))] <- paste0(colnames(tb2)[!(colnames(tb2) %in% c('cm'))],'(est)')
  
  tb <- inner_join(tb1, tb0) %>% inner_join(tb2) %>%
    dplyr::mutate(celltypes = gsub('\\:.*','',cm), markers = gsub('.*\\:','',cm)) %>% 
    dplyr::select(-cm)
  tb <- tb %>% dplyr::select(c('celltypes','markers',sort(colnames(.))[!(colnames(.) %in% c('celltypes','markers'))])) %>% 
    mutate_if(is.numeric, function(x) round(x, 2))
  
  return(list(tb=tb, df=df))
}



data_summary <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,varname)
  data_sum <- rename(data_sum, c("mean" = varname))
  return(data_sum)
}
```

### DEA:CD8+ T cell

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
## Within CD8+ Tcells, how marker changes(log2FC data)
celltypes <- c("CD4+","CD8+")
dea.res1 <- NULL
dea.res1 <- perform_DEA_CyTOF(data = cell.marker.mean.agg.lfc, celltypes = celltypes, 
                              sam.col = 'sam.ids', method = 'lm',transform = NULL,
                              BRAF.sub =BRAF.sub, subsetBRAF = subsetBRAF,
                              meta.dat = meta.samples, timepoints = c('C1','C3','C4'), 
                              variables = grp.name,adj.name = adj.name)
tb <- dea2tb(dea.res1)
res <- tb$tb[,c(1:2,4,7,10)]
reactable(res[res$celltypes %in% 'CD8+',], pageSizeOptions = 10, pagination = T, filterable = TRUE,
          columns = list(celltypes = colDef(minWidth = 300), markers = colDef(minWidth = 200)))
# write.csv(res, file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/CD8+Tcell_[mean]DEA_",BRAF.sub,".csv"), row.names = F)
```

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
sub.class = 'CD8+'
CD8.df <- cell.marker.mean.agg.lfc[,sub.class,]
plt <- plt1 <- list()
markers <- c("CTLA-4", "PD-1","PD-L1",'TIGIT','Tim-3','LAG-3')
for(marker in markers){
  plt.df <- full_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                      meta.samples[,c('sam.ids','PR4.n','TimePoint')]) %>% dplyr::filter(TimePoint!='BASELINE')
  colnames(plt.df)[2] <- 'marker'
  colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
  plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
  plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
    geom_line() +
    geom_point()+
    geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  CD8.tmp <- res[res$celltypes==sub.class,]
  colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
  rownames(CD8.tmp) <- NULL
  CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
  colnames(CD8.tmp)[2] <- 'p'
  plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
  plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
    geom_boxplot() + 
    geom_jitter(position = position_jitterdodge(0.5)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  
}
# ggarrange(plt$`CTLA-4`, plt$`PD-1`, plt$`PD-L1`, plt$TIGIT, plt$`Tim-3`, plt$`LAG-3`, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2A_",BRAF.sub,".pdf"), 
#        width = 12, height = 8)
pp <- ggarrange(plt1$`CTLA-4`, plt1$`PD-1`, plt1$`PD-L1`, plt1$TIGIT, plt1$`Tim-3`, plt1$`LAG-3`, common.legend = T)
print(pp)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2A_",BRAF.sub,"_boxplot.pdf"), 
#        width = 12, height = 8)
```

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
plt <- plt1 <- list()
markers <- c("CX3CR1", "CD161")
for(marker in markers){
  plt.df <- full_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                      meta.samples[,c('sam.ids','PR4.n','TimePoint')]) %>% dplyr::filter(TimePoint!='BASELINE')
  colnames(plt.df)[2] <- 'marker'
  colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
  plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
  plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
    geom_line() +
    geom_point()+
    geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  CD8.tmp <- res[res$celltypes=='CD8+',]
  colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
  rownames(CD8.tmp) <- NULL
  CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
  colnames(CD8.tmp)[2] <- 'p'
  plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
  plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
    geom_boxplot() + 
    geom_jitter(position = position_jitterdodge(0.5)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  
}
# ggarrange(plt$CX3CR1,plt$CD161, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2B_",BRAF.sub,".pdf"), 
#        width = 8, height = 4)
pp <- ggarrange(plt1$CX3CR1,plt1$CD161, common.legend = T)
print(pp)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2B_",BRAF.sub,"_boxplot.pdf"), 
#        width = 8, height = 4)
```

### DEA:CD4+ T cell
```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
reactable(res[res$celltypes %in% 'CD4+',], pageSizeOptions = 10, pagination = T, filterable = TRUE,
          columns = list(celltypes = colDef(minWidth = 300), markers = colDef(minWidth = 200)))
sub.class = 'CD4+'
CD8.df <- cell.marker.mean.agg.lfc[,sub.class,]
plt <- plt1 <- list()
markers <- c("CTLA-4", "PD-1","PD-L1",'TIGIT','Tim-3','LAG-3')
for(marker in markers){
  plt.df <- full_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                      meta.samples[,c('sam.ids','PR4.n','TimePoint')]) %>% dplyr::filter(TimePoint!='BASELINE')
  colnames(plt.df)[2] <- 'marker'
  colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
  plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
  plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
    geom_line() +
    geom_point()+
    geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  CD8.tmp <- res[res$celltypes==sub.class,]
  colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
  rownames(CD8.tmp) <- NULL
  CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
  colnames(CD8.tmp)[2] <- 'p'
  plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
  plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
    geom_boxplot() + 
    geom_jitter(position = position_jitterdodge(0.5)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  
}
# ggarrange(plt$`CTLA-4`, plt$`PD-1`, plt$`PD-L1`, plt$TIGIT, plt$`Tim-3`, plt$`LAG-3`, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2A_",BRAF.sub,"_CD4.pdf"), 
#        width = 12, height = 8)
pp <- ggarrange(plt1$`CTLA-4`, plt1$`PD-1`, plt1$`PD-L1`, plt1$TIGIT, plt1$`Tim-3`, plt1$`LAG-3`, common.legend = T)
print(pp)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2A_",BRAF.sub,"_CD4_boxplot.pdf"), 
#        width = 12, height = 8)
```

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
plt <- plt1 <- list()
markers <- c("CX3CR1", "CD161")
for(marker in markers){
  plt.df <- full_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                      meta.samples[,c('sam.ids','PR4.n','TimePoint')]) %>% dplyr::filter(TimePoint!='BASELINE')
  colnames(plt.df)[2] <- 'marker'
  colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
  plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
  plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
    geom_line() +
    geom_point()+
    geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  CD8.tmp <- res[res$celltypes==sub.class,]
  colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
  rownames(CD8.tmp) <- NULL
  CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
  colnames(CD8.tmp)[2] <- 'p'
  plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
  plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
    geom_boxplot() + 
    geom_jitter(position = position_jitterdodge(0.5)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
}
# ggarrange(plt$CX3CR1,plt$CD161, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2B_",BRAF.sub,"_CD4.pdf"), 
#        width = 8, height = 4)
pp <- ggarrange(plt1$CX3CR1,plt1$CD161, common.legend = T)
print(pp)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2B_",BRAF.sub,"_CD4_boxplot.pdf"), 
#        width = 8, height = 4)
```

### DEA:CD8+ T Cell (Central Memory)

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
## Figure2A&B
celltypes <- c("CD4+ T Cell (Effector Memory)","CD8+ T Cell (Central Memory)")
dea.res1 <- NULL
dea.res1 <- perform_DEA_CyTOF(data = cell.marker.mean.lfc, celltypes = celltypes, 
                              sam.col = 'sam.ids', method = 'lm',transform = NULL,
                              BRAF.sub =BRAF.sub, subsetBRAF = subsetBRAF,
                              meta.dat = meta.samples, timepoints = c('C1','C3','C4'), 
                              variables = grp.name,adj.name = adj.name)
tb <- dea2tb(dea.res1)
res <- tb$tb[,c(1:2,4,7,10)] 
res$group <- 'CD8+ T cell'
res[res$celltypes %in% res$celltypes[grep('^CD4',res$celltypes)],'group'] <- 'CD4+ T cell'
# write.csv(res, file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/CD8+TCM_CD4TEM_baseline[mean]DEA_",BRAF.sub,".csv"), row.names = F)
reactable(res[res$celltypes %in% "CD8+ T Cell (Central Memory)", ], pageSizeOptions = 10, pagination = T, filterable = TRUE,
          columns = list(celltypes = colDef(minWidth = 300), markers = colDef(minWidth = 200)))
```

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
CD8.df <- cell.marker.mean.lfc[,"CD8+ T Cell (Central Memory)",]
plt <- plt1 <- list()
markers <- c("CTLA-4", "PD-1","PD-L1",'TIGIT','Tim-3','LAG-3')
for(marker in markers){
  plt.df <- full_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                      meta.samples[,c('sam.ids','PR4.n','TimePoint')]) %>% dplyr::filter(TimePoint!='BASELINE')
  colnames(plt.df)[2] <- 'marker'
  colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
  plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
  plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
    geom_line() +
    geom_point()+
    geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  CD8.tmp <- res[res$celltypes=="CD8+ T Cell (Central Memory)",] %>% dplyr::select(-'group')
  colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
  rownames(CD8.tmp) <- NULL
  CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
  colnames(CD8.tmp)[2] <- 'p'
  plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
  plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
    geom_boxplot() + 
    geom_jitter(position = position_jitterdodge(0.5)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  
}
# ggarrange(plt$`CTLA-4`, plt$`PD-1`, plt$`PD-L1`, plt$TIGIT, plt$`Tim-3`, plt$`LAG-3`, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2A_CD8TCM_",BRAF.sub,".pdf"), 
#        width = 12, height = 8)
pp <- ggarrange(plt1$`CTLA-4`, plt1$`PD-1`, plt1$`PD-L1`, plt1$TIGIT, plt1$`Tim-3`, plt1$`LAG-3`, common.legend = T)
print(pp)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2A_CD8TCM_",BRAF.sub,"_boxplot.pdf"), width = 12, height = 8)
```

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
plt <- plt1 <- list()
markers <- c("CX3CR1", "CD161")
for(marker in markers){
  plt.df <- full_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                      meta.samples[,c('sam.ids','PR4.n','TimePoint')]) %>% dplyr::filter(TimePoint!='BASELINE')
  colnames(plt.df)[2] <- 'marker'
  colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
  plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
  plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
    geom_line() +
    geom_point()+
    geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  CD8.tmp <- res[res$celltypes=="CD8+ T Cell (Central Memory)",] %>% dplyr::select(-'group')
  colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
  rownames(CD8.tmp) <- NULL
  CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
  colnames(CD8.tmp)[2] <- 'p'
  plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
  plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
    geom_boxplot() + 
    geom_jitter(position = position_jitterdodge(0.5)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  
}
# ggarrange(plt$CX3CR1,plt$CD161, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2B_CD8TCM_",BRAF.sub,".pdf"), 
#        width = 8, height = 4)
pp <- ggarrange(plt1$CX3CR1,plt1$CD161, common.legend = T)
print(pp)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2B_CD8TCM_",BRAF.sub,"_boxplot.pdf"), width = 8, height = 4)
```

### DEA:CD4+ T Cell (Effector Memory)

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=10, message=FALSE, warning=FALSE, include=T, results="asis"}
reactable(res[res$celltypes %in% "CD4+ T Cell (Effector Memory)", ], pageSizeOptions = 10, pagination = T, filterable = TRUE,
          columns = list(celltypes = colDef(minWidth = 300), markers = colDef(minWidth = 200)))
CD4.df <- cell.marker.mean.lfc[,"CD4+ T Cell (Effector Memory)",]
plt <- plt1 <- list()
markers <- c("CTLA-4", "PD-1","PD-L1",'TIGIT','Tim-3','LAG-3')
for(marker in markers){
  plt.df <- full_join(as.data.frame(CD4.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                      meta.samples[,c('sam.ids','PR4.n','TimePoint')]) %>% dplyr::filter(TimePoint!='BASELINE')
  colnames(plt.df)[2] <- 'marker'
  colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
  plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
  plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
    geom_line() +
    geom_point()+
    geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  CD8.tmp <- res[res$celltypes=="CD4+ T Cell (Effector Memory)",] %>% dplyr::select(-'group')
  colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
  rownames(CD8.tmp) <- NULL
  CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
  colnames(CD8.tmp)[2] <- 'p'
  plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
  plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
    geom_boxplot() + 
    geom_jitter(position = position_jitterdodge(0.5)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  
}
# ggarrange(plt$`CTLA-4`, plt$`PD-1`, plt$`PD-L1`, plt$TIGIT, plt$`Tim-3`, plt$`LAG-3`, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2A_CD4TEM_",BRAF.sub,".pdf"), 
#        width = 12, height = 8)
ggarrange(plt1$`CTLA-4`, plt1$`PD-1`, plt1$`PD-L1`, plt1$TIGIT, plt1$`Tim-3`, plt1$`LAG-3`, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2A_CD4TEM_",BRAF.sub,"_boxplot.pdf"), 
#        width = 12, height = 8)
```

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
plt <- plt1 <- list()
markers <- c("CX3CR1", "CD161")
for(marker in markers){
  plt.df <- full_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                      meta.samples[,c('sam.ids','PR4.n','TimePoint')]) %>% dplyr::filter(TimePoint!='BASELINE')
  colnames(plt.df)[2] <- 'marker'
  colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
  plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
  plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
    geom_line() +
    geom_point()+
    geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  CD8.tmp <- res[res$celltypes=="CD4+ T Cell (Effector Memory)",] %>% dplyr::select(-'group')
  colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
  rownames(CD8.tmp) <- NULL
  CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
  colnames(CD8.tmp)[2] <- 'p'
  plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
  plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
    geom_boxplot() + 
    geom_jitter(position = position_jitterdodge(0.5)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  
}
# ggarrange(plt$CX3CR1,plt$CD161, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2B_CD4TEM_",BRAF.sub,".pdf"), 
#        width = 8, height = 4)
pp <- ggarrange(plt1$CX3CR1,plt1$CD161, common.legend = T)
print(pp)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2B_CD4TEM_",BRAF.sub,"_boxplot.pdf"), width = 8, height = 4)
```


## 3.Within BRAFm

```{r, message=FALSE, message=F, warning=F, echo=FALSE, results='hide'}
grp.name= 'PR4.n'
adj.name= NULL
subsetBRAF= TRUE
BRAF.sub='BRAFm'
```

```{r, message=FALSE, message=F, warning=F, echo=FALSE, results='hide'}
source(paste0(root.dir,'Code/Stats.R'))
source(paste0(root.dir,'Code/Func.R'))

cell.abund.obj <- cell.prop.obj <- cell.diff.obj <- list()
i = 0
for(level in c('Compartment','Assignment','Profiling')){
  i = i + 1
  output <- paste0(root.dir,'Result/',level)
  load(file.path(root.dir,'Data/2022_09_29', paste0(level, '.RData')))
  meta.dat$SubjectID <- gsub('WWV54','WVW54',meta.dat$SubjectID)
  
  if(subsetBRAF ==T){
    meta.dat <- meta.dat[meta.dat$file_name !="20201028_AG489_C1" & meta.dat$BRAF == BRAF.sub,]
  }else{
    meta.dat <- meta.dat[meta.dat$file_name !="20201028_AG489_C1", ]
  }
  cell.count <- cell.count[meta.dat$file_name,,drop =F]
  cell.freq <- cell.freq[meta.dat$file_name,,drop =F]
  # cell.count <- cell.count[,unique(BTNK[,tolower(level)])]
  ## cell.diff.obj 
  cell.count0 <- cell.count + 0.5
  size.factor <- rowSums(cell.count0)
  cell.freq <- cell.count0 / size.factor
  cell.freq.base <- cell.freq[meta.dat[meta.dat$TimePoint == 'BASELINE','file_name'], ]
  rownames(cell.freq.base) <- gsub("^([^_]*_[^_]*)_.*$", "\\1", rownames(cell.freq.base))
  base.name <- rownames(cell.freq.base)
  cell.freq.diff <- names <- NULL
  for(k in c('BASELINE','C1','C3','C4')){
    cell.time <- cell.freq[meta.dat[meta.dat$TimePoint == k,'file_name'], ]
    names <- c(names, rownames(cell.time))
    rownames(cell.time) <- gsub("^([^_]*_[^_]*)_.*$", "\\1", rownames(cell.time))
    cell.freq.diff <- rbind(cell.freq.diff, cell.time/cell.freq.base[rownames(cell.time),])
  }
  rownames(cell.freq.diff) <- names
  cell.freq.diff <- log2(cell.freq.diff) #log fold change from the baseline
  # cell.freq.diff.sqrt <- sign(cell.freq.diff) * sqrt(abs(cell.freq.diff ))
  
  cell.count.filter <- cell.count[,colSums(cell.count) > 0]
  cell.diff.obj[[paste0('level', i)]] <- cell.freq.diff[,colnames(cell.count.filter)]
  # cell.abund.obj[[paste0('level', i)]] <- cell.count
  cell.abund.obj[[paste0('level', i)]] <- cell.count.filter
  cell.prop.obj[[paste0('level', i)]] <- cell.freq[,colnames(cell.count)] # not filtered , all cells
}
names(cell.abund.obj) <- names(cell.prop.obj) <- names(cell.diff.obj)  <- c('Compartment','Assignment','Profiling')

meta.samples <- meta.dat[,c('file_name','TimePoint','BRAF','PR2','RunDate','patient_id','PR2.n','PR4.n')] %>% dplyr::rename(SubjectID = patient_id)
colnames(meta.samples)[1] <- 'sam.ids'
meta.samples$PR2.n <- as.factor(meta.samples$PR2.n)
meta.samples$PR4.n <- as.factor(meta.samples$PR4.n)
meta.samples <- within(meta.samples, BRAF <- relevel(BRAF, ref = 1))
meta.samples <- within(meta.samples, PR2 <- relevel(PR2, ref = 1))
```

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
###-------------------- DEA --------------
## exclude outlier sample
level = 'Assignment'
tmp <- load(paste0("/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022/agg_trans/",level,".RData"))
meta.dat$SubjectID <- gsub('WWV54','WVW54',meta.dat$SubjectID)

if(subsetBRAF == T){
  meta.samples <- meta.samples[meta.samples$sam.ids != "20201028_AG489_C1" & meta.samples$BRAF == BRAF.sub,,drop =F]
}else{
  meta.samples <- meta.samples[meta.samples$sam.ids != "20201028_AG489_C1" ,,drop =F]
}

files <- meta.samples$sam.ids
cell.marker.mean0 <- cell.marker.cvs0 <- cell.marker.median0 <- cell.marker.90qt0 <- cell.marker.99qt0 <- 
  array(NA, c(length(files), length(dimnames(cell.marker.mean)[[2]]), length(dimnames(cell.marker.mean)[[3]])), 
        dimnames = list(files, dimnames(cell.marker.mean)[[2]],dimnames(cell.marker.mean)[[3]]))
for(file in files){
  cell.marker.mean0[file,,] <- cell.marker.mean[file,,] 
  cell.marker.median0[file,,] <- cell.marker.median[file,,] 
  cell.marker.cvs0[file,,] <- cell.marker.cvs[file,,] 
  cell.marker.90qt0[file,,] <- cell.marker.90qt[file,,] 
  cell.marker.99qt0[file,,] <- cell.marker.99qt[file,,] 
}

cell.marker.mean <- cell.marker.mean0
cell.marker.median <- cell.marker.median0
cell.marker.90qt <- cell.marker.90qt0
cell.marker.99qt <- cell.marker.99qt0


### log fold change from baseline
cell.marker.90qt.lfc <- lfc.func(cell.marker = cell.marker.90qt)$cell.marker.lfc
cell.marker.90qt.diff.sqrt <- lfc.func(cell.marker = cell.marker.90qt)$cell.marker.diff.sqrt
cell.marker.mean.lfc <- lfc.func(cell.marker = cell.marker.mean)$cell.marker.lfc


## aggregate CD4+ or CD8+ cells 
level = 'Assignment'
tmp <- load(paste0("/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022/agg_trans/",level,".RData"))
meta.dat$SubjectID <- gsub('WWV54','WVW54',meta.dat$SubjectID)

if(subsetBRAF == T){
  meta.samples <- meta.samples[meta.samples$sam.ids != "20201028_AG489_C1" & meta.samples$BRAF == BRAF.sub,,drop =F]
}else{
  meta.samples <- meta.samples[meta.samples$sam.ids != "20201028_AG489_C1" ,,drop =F]
}

files <- meta.samples$sam.ids
celltypes.CD4 <- unique(BTNK[,tolower(level)])[grep('^CD4\\+\\ T',unique(BTNK[,tolower(level)]))]
celltypes.CD8 <- unique(BTNK[,tolower(level)])[grep('^CD8\\+\\ T',unique(BTNK[,tolower(level)]))]

cell.marker.mean1 <- cell.marker.cvs1 <- cell.marker.median1 <- cell.marker.90qt1 <- cell.marker.99qt1 <- 
  array(NA, c(length(files), 2, length(dimnames(cell.marker.mean)[[3]])), 
        dimnames = list(files, c('CD4+','CD8+'),dimnames(cell.marker.mean)[[3]]))
for(file in files){
  tmp1 <- as.data.frame(cell.marker.mean[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  tmp2 <- as.data.frame(cell.marker.median[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  tmp3 <- as.data.frame(cell.marker.cvs[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  tmp4 <- as.data.frame(cell.marker.90qt[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  tmp5 <- as.data.frame(cell.marker.99qt[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  cell.marker.mean1[file,,] <- tmp1
  cell.marker.median1[file,,] <- tmp2
  cell.marker.cvs1[file,,] <- tmp3
  cell.marker.90qt1[file,,] <- tmp4
  cell.marker.99qt1[file,,] <- tmp5
}

cell.marker.mean.agg <- cell.marker.mean1
cell.marker.median.agg <- cell.marker.median1
cell.marker.90qt.agg <- cell.marker.90qt1
cell.marker.99qt.agg <- cell.marker.99qt1


cell.marker.90qt.agg.lfc <- lfc.func(cell.marker = cell.marker.90qt.agg)$cell.marker.lfc
cell.marker.90qt.agg.diff.sqrt <- lfc.func(cell.marker = cell.marker.90qt.agg)$cell.marker.diff.sqrt
cell.marker.mean.agg.lfc <- lfc.func(cell.marker = cell.marker.mean.agg)$cell.marker.lfc

dea2tb <- function(dea.res1){
  df1 = list_df(dea.res = dea.res1, list.name = 'raw.p') %>% 
    dplyr::mutate(type = 'raw.p') %>% dplyr::select(-variables)
  df2 = list_df(dea.res = dea.res1, list.name = 'result') %>% 
    dplyr::mutate(type = 'fdr') %>% dplyr::select(-variables)
  df3 = list_df(dea.res = dea.res1, list.name = 'coefs') %>% 
    dplyr::mutate(type = 'coef') %>% dplyr::select(-variables)
  df4 = list_df(dea.res = dea.res1, list.name = 'sd.errs') %>% 
    dplyr::mutate(type = 'sd.err') %>% dplyr::select(-variables)
  df <- rbind(df1, df2, df3, df4) %>% spread(type, value) %>% na.omit() %>% 
    dplyr::mutate(coef = round(coef,2), fdr = fdr, raw.p = raw.p, sd.err = round(sd.err,2))%>% 
    arrange(raw.p)
  
  tb0 <- df %>% dplyr::mutate(cm = paste0(celltypes,':',markers)) %>% 
    dplyr::select(cm,TimePoints, fdr) %>% spread(TimePoints, fdr) 
  colnames(tb0)[!(colnames(tb0) %in% c('cm'))] <- paste0(colnames(tb0)[!(colnames(tb0) %in% c('cm'))],'(q)')
  
  tb1 <- df %>% dplyr::mutate(cm = paste0(celltypes,':',markers)) %>% 
    dplyr::select(cm,TimePoints, raw.p) %>% spread(TimePoints, raw.p) 
  colnames(tb1)[!(colnames(tb1) %in% c('cm'))] <- paste0(colnames(tb1)[!(colnames(tb1) %in% c('cm'))],'(p)')
  
  tb2 <- df %>% dplyr::mutate( cm = paste0(celltypes,':',markers)) %>% 
    dplyr::select(cm,TimePoints, coef) %>% spread(TimePoints, coef) 
  colnames(tb2)[!(colnames(tb2) %in% c('cm'))] <- paste0(colnames(tb2)[!(colnames(tb2) %in% c('cm'))],'(est)')
  
  tb <- inner_join(tb1, tb0) %>% inner_join(tb2) %>%
    dplyr::mutate(celltypes = gsub('\\:.*','',cm), markers = gsub('.*\\:','',cm)) %>% 
    dplyr::select(-cm)
  tb <- tb %>% dplyr::select(c('celltypes','markers',sort(colnames(.))[!(colnames(.) %in% c('celltypes','markers'))])) %>% 
    mutate_if(is.numeric, function(x) round(x, 2))
  
  return(list(tb=tb, df=df))
}



data_summary <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,varname)
  data_sum <- rename(data_sum, c("mean" = varname))
  return(data_sum)
}
```

### DEA:CD8+ T cell

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
## Within CD8+ Tcells, how marker changes(log2FC data)
celltypes <- c("CD4+","CD8+")
dea.res1 <- NULL
dea.res1 <- perform_DEA_CyTOF(data = cell.marker.mean.agg.lfc, celltypes = celltypes, 
                              sam.col = 'sam.ids', method = 'lm',transform = NULL,
                              BRAF.sub =BRAF.sub, subsetBRAF = subsetBRAF,
                              meta.dat = meta.samples, timepoints = c('C1','C3','C4'), 
                              variables = grp.name,adj.name = adj.name)
tb <- dea2tb(dea.res1)
res <- tb$tb[,c(1:2,4,7,10)]
reactable(res[res$celltypes %in% 'CD8+',], pageSizeOptions = 10, pagination = T, filterable = TRUE,
          columns = list(celltypes = colDef(minWidth = 300), markers = colDef(minWidth = 200)))
# write.csv(res, file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/CD8+Tcell_[mean]DEA_",BRAF.sub,".csv"), row.names = F)
```

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
sub.class = 'CD8+'
CD8.df <- cell.marker.mean.agg.lfc[,sub.class,]
plt <- plt1 <- list()
markers <- c("CTLA-4", "PD-1","PD-L1",'TIGIT','Tim-3','LAG-3')
for(marker in markers){
  plt.df <- full_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                      meta.samples[,c('sam.ids','PR4.n','TimePoint')]) %>% dplyr::filter(TimePoint!='BASELINE')
  colnames(plt.df)[2] <- 'marker'
  colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
  plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
  plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
    geom_line() +
    geom_point()+
    geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  CD8.tmp <- res[res$celltypes==sub.class,]
  colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
  rownames(CD8.tmp) <- NULL
  CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
  colnames(CD8.tmp)[2] <- 'p'
  plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
  plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
    geom_boxplot() + 
    geom_jitter(position = position_jitterdodge(0.5)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  
}
# ggarrange(plt$`CTLA-4`, plt$`PD-1`, plt$`PD-L1`, plt$TIGIT, plt$`Tim-3`, plt$`LAG-3`, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2A_",BRAF.sub,".pdf"), 
#        width = 12, height = 8)
pp <- ggarrange(plt1$`CTLA-4`, plt1$`PD-1`, plt1$`PD-L1`, plt1$TIGIT, plt1$`Tim-3`, plt1$`LAG-3`, common.legend = T)
print(pp)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2A_",BRAF.sub,"_boxplot.pdf"), 
#        width = 12, height = 8)
```

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
plt <- plt1 <- list()
markers <- c("CX3CR1", "CD161")
for(marker in markers){
  plt.df <- full_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                      meta.samples[,c('sam.ids','PR4.n','TimePoint')]) %>% dplyr::filter(TimePoint!='BASELINE')
  colnames(plt.df)[2] <- 'marker'
  colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
  plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
  plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
    geom_line() +
    geom_point()+
    geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  CD8.tmp <- res[res$celltypes=='CD8+',]
  colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
  rownames(CD8.tmp) <- NULL
  CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
  colnames(CD8.tmp)[2] <- 'p'
  plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
  plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
    geom_boxplot() + 
    geom_jitter(position = position_jitterdodge(0.5)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  
}
# ggarrange(plt$CX3CR1,plt$CD161, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2B_",BRAF.sub,".pdf"), 
#        width = 8, height = 4)
pp <- ggarrange(plt1$CX3CR1,plt1$CD161, common.legend = T)
print(pp)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2B_",BRAF.sub,"_boxplot.pdf"), 
#        width = 8, height = 4)
```

### DEA:CD4+ T cell

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
reactable(res[res$celltypes %in% 'CD4+',], pageSizeOptions = 10, pagination = T, filterable = TRUE,
          columns = list(celltypes = colDef(minWidth = 300), markers = colDef(minWidth = 200)))
sub.class = 'CD4+'
CD8.df <- cell.marker.mean.agg.lfc[,sub.class,]
plt <- plt1 <- list()
markers <- c("CTLA-4", "PD-1","PD-L1",'TIGIT','Tim-3','LAG-3')
for(marker in markers){
  plt.df <- full_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                      meta.samples[,c('sam.ids','PR4.n','TimePoint')]) %>% dplyr::filter(TimePoint!='BASELINE')
  colnames(plt.df)[2] <- 'marker'
  colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
  plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
  plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
    geom_line() +
    geom_point()+
    geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  CD8.tmp <- res[res$celltypes==sub.class,]
  colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
  rownames(CD8.tmp) <- NULL
  CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
  colnames(CD8.tmp)[2] <- 'p'
  plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
  plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
    geom_boxplot() + 
    geom_jitter(position = position_jitterdodge(0.5)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  
}
# ggarrange(plt$`CTLA-4`, plt$`PD-1`, plt$`PD-L1`, plt$TIGIT, plt$`Tim-3`, plt$`LAG-3`, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2A_",BRAF.sub,"_CD4.pdf"), 
#        width = 12, height = 8)
pp <- ggarrange(plt1$`CTLA-4`, plt1$`PD-1`, plt1$`PD-L1`, plt1$TIGIT, plt1$`Tim-3`, plt1$`LAG-3`, common.legend = T)
print(pp)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2A_",BRAF.sub,"_CD4_boxplot.pdf"), 
#        width = 12, height = 8)
```

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
plt <- plt1 <- list()
markers <- c("CX3CR1", "CD161")
for(marker in markers){
  plt.df <- full_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                      meta.samples[,c('sam.ids','PR4.n','TimePoint')]) %>% dplyr::filter(TimePoint!='BASELINE')
  colnames(plt.df)[2] <- 'marker'
  colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
  plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
  plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
    geom_line() +
    geom_point()+
    geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  CD8.tmp <- res[res$celltypes==sub.class,]
  colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
  rownames(CD8.tmp) <- NULL
  CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
  colnames(CD8.tmp)[2] <- 'p'
  plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
  plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
    geom_boxplot() + 
    geom_jitter(position = position_jitterdodge(0.5)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
}
# ggarrange(plt$CX3CR1,plt$CD161, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2B_",BRAF.sub,"_CD4.pdf"), 
#        width = 8, height = 4)
pp <- ggarrange(plt1$CX3CR1,plt1$CD161, common.legend = T)
print(pp)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2B_",BRAF.sub,"_CD4_boxplot.pdf"), 
#        width = 8, height = 4)
```

### DEA:CD8+ T Cell (Central Memory)

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
## Figure2A&B
celltypes <- c("CD4+ T Cell (Effector Memory)","CD8+ T Cell (Central Memory)")
dea.res1 <- NULL
dea.res1 <- perform_DEA_CyTOF(data = cell.marker.mean.lfc, celltypes = celltypes, 
                              sam.col = 'sam.ids', method = 'lm',transform = NULL,
                              BRAF.sub =BRAF.sub, subsetBRAF = subsetBRAF,
                              meta.dat = meta.samples, timepoints = c('C1','C3','C4'), 
                              variables = grp.name,adj.name = adj.name)
tb <- dea2tb(dea.res1)
res <- tb$tb[,c(1:2,4,7,10)] 
res$group <- 'CD8+ T cell'
res[res$celltypes %in% res$celltypes[grep('^CD4',res$celltypes)],'group'] <- 'CD4+ T cell'
# write.csv(res, file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/CD8+TCM_CD4TEM_baseline[mean]DEA_",BRAF.sub,".csv"), row.names = F)
reactable(res[res$celltypes %in% "CD8+ T Cell (Central Memory)",], pageSizeOptions = 10, pagination = T, filterable = TRUE,
          columns = list(celltypes = colDef(minWidth = 300), markers = colDef(minWidth = 200)))
```

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
CD8.df <- cell.marker.mean.lfc[,"CD8+ T Cell (Central Memory)",]
plt <- plt1 <- list()
markers <- c("CTLA-4", "PD-1","PD-L1",'TIGIT','Tim-3','LAG-3')
for(marker in markers){
  plt.df <- full_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                      meta.samples[,c('sam.ids','PR4.n','TimePoint')]) %>% dplyr::filter(TimePoint!='BASELINE')
  colnames(plt.df)[2] <- 'marker'
  colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
  plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
  plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
    geom_line() +
    geom_point()+
    geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  CD8.tmp <- res[res$celltypes=="CD8+ T Cell (Central Memory)",] %>% dplyr::select(-'group')
  colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
  rownames(CD8.tmp) <- NULL
  CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
  colnames(CD8.tmp)[2] <- 'p'
  plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
  plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
    geom_boxplot() + 
    geom_jitter(position = position_jitterdodge(0.5)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  
}
# ggarrange(plt$`CTLA-4`, plt$`PD-1`, plt$`PD-L1`, plt$TIGIT, plt$`Tim-3`, plt$`LAG-3`, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2A_CD8TCM_",BRAF.sub,".pdf"), 
#        width = 12, height = 8)
pp <- ggarrange(plt1$`CTLA-4`, plt1$`PD-1`, plt1$`PD-L1`, plt1$TIGIT, plt1$`Tim-3`, plt1$`LAG-3`, common.legend = T)
print(pp)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2A_CD8TCM_",BRAF.sub,"_boxplot.pdf"), width = 12, height = 8)
```

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
plt <- plt1 <- list()
markers <- c("CX3CR1", "CD161")
for(marker in markers){
  plt.df <- full_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                      meta.samples[,c('sam.ids','PR4.n','TimePoint')]) %>% dplyr::filter(TimePoint!='BASELINE')
  colnames(plt.df)[2] <- 'marker'
  colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
  plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
  plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
    geom_line() +
    geom_point()+
    geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  CD8.tmp <- res[res$celltypes=="CD8+ T Cell (Central Memory)",] %>% dplyr::select(-'group')
  colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
  rownames(CD8.tmp) <- NULL
  CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
  colnames(CD8.tmp)[2] <- 'p'
  plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
  plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
    geom_boxplot() + 
    geom_jitter(position = position_jitterdodge(0.5)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  
}
# ggarrange(plt$CX3CR1,plt$CD161, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2B_CD8TCM_",BRAF.sub,".pdf"), 
#        width = 8, height = 4)
pp <- ggarrange(plt1$CX3CR1,plt1$CD161, common.legend = T)
print(pp)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2B_CD8TCM_",BRAF.sub,"_boxplot.pdf"), width = 8, height = 4)
```

### DEA:CD4+ T Cell (Effector Memory)

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=10, message=FALSE, warning=FALSE, include=T, results="asis"}
reactable(res[res$celltypes %in% "CD4+ T Cell (Effector Memory)",], pageSizeOptions = 10, pagination = T, filterable = TRUE,
          columns = list(celltypes = colDef(minWidth = 300), markers = colDef(minWidth = 200)))
CD4.df <- cell.marker.mean.lfc[,"CD4+ T Cell (Effector Memory)",]
plt <- plt1 <- list()
markers <- c("CTLA-4", "PD-1","PD-L1",'TIGIT','Tim-3','LAG-3')
for(marker in markers){
  plt.df <- full_join(as.data.frame(CD4.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                      meta.samples[,c('sam.ids','PR4.n','TimePoint')]) %>% dplyr::filter(TimePoint!='BASELINE')
  colnames(plt.df)[2] <- 'marker'
  colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
  plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
  plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
    geom_line() +
    geom_point()+
    geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  CD8.tmp <- res[res$celltypes=="CD4+ T Cell (Effector Memory)",] %>% dplyr::select(-'group')
  colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
  rownames(CD8.tmp) <- NULL
  CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
  colnames(CD8.tmp)[2] <- 'p'
  plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
  plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
    geom_boxplot() + 
    geom_jitter(position = position_jitterdodge(0.5)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  
}
# ggarrange(plt$`CTLA-4`, plt$`PD-1`, plt$`PD-L1`, plt$TIGIT, plt$`Tim-3`, plt$`LAG-3`, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2A_CD4TEM_",BRAF.sub,".pdf"), 
#        width = 12, height = 8)
ggarrange(plt1$`CTLA-4`, plt1$`PD-1`, plt1$`PD-L1`, plt1$TIGIT, plt1$`Tim-3`, plt1$`LAG-3`, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2A_CD4TEM_",BRAF.sub,"_boxplot.pdf"), 
#        width = 12, height = 8)
```

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=12, message=FALSE, warning=FALSE, include=T, results="asis"}
plt <- plt1 <- list()
markers <- c("CX3CR1", "CD161")
for(marker in markers){
  plt.df <- full_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                      meta.samples[,c('sam.ids','PR4.n','TimePoint')]) %>% dplyr::filter(TimePoint!='BASELINE')
  colnames(plt.df)[2] <- 'marker'
  colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
  plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
  plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
    geom_line() +
    geom_point()+
    geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  CD8.tmp <- res[res$celltypes=="CD4+ T Cell (Effector Memory)",] %>% dplyr::select(-'group')
  colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
  rownames(CD8.tmp) <- NULL
  CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
  colnames(CD8.tmp)[2] <- 'p'
  plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
  plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
    geom_boxplot() + 
    geom_jitter(position = position_jitterdodge(0.5)) +
    theme_classic() + 
    geom_hline(yintercept = 0,linetype = "dashed") + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text = element_text(size = 12, color = 'black'),
          axis.title = element_text(size = 12, color = 'black'),
          legend.text = element_text(size = 12, color = 'black'),
          legend.title = element_text(size = 12, color = 'black')) + 
    labs(y = 'log2 change (from baseline)') + 
    ggtitle(marker)
  
}
# ggarrange(plt$CX3CR1,plt$CD161, common.legend = T)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2B_CD4TEM_",BRAF.sub,".pdf"), 
#        width = 8, height = 4)
pp <- ggarrange(plt1$CX3CR1,plt1$CD161, common.legend = T)
print(pp)
# #ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/Figure2B_CD4TEM_",BRAF.sub,"_boxplot.pdf"), width = 8, height = 4)
```


# Subclass analysis
 
* This part shows results of:
 
    - differential abundance analysis(DAA) of cell types at profiling level within CD8+ T Cell (Central Memory) and CD4+ T Cell (Effector Memory).
    
    - differential expression analysis(DEA) of marker expression within cell types at profiling level within CD8+ T Cell (Central Memory) and CD4+ T Cell (Effector Memory).

* Tables show raw P-value of DAA or DEA, followed by boxplots.

* For DAA: We used the raw count data followed by TSS normalization and asingsqrt transformation.

* For DEA: We used the mean marker expression data followed by log2 transformation.
 
## 1.Within all samples

```{r, message=FALSE, message=F, warning=F, echo=FALSE, results='hide'}
grp.name= 'PR4.n'
adj.name= 'BRAF'
subsetBRAF= FALSE
BRAF.sub=NULL
```

```{r, message=FALSE, message=F, warning=F, echo=FALSE, results='hide'}
source(paste0(root.dir,'Code/Stats.R'))
source(paste0(root.dir,'Code/Func.R'))

cell.abund.obj <- cell.prop.obj <- cell.diff.obj <- list()
i = 0
for(level in c('Compartment','Assignment','Profiling')){
  i = i + 1
  output <- paste0(root.dir,'Result/',level)
  load(file.path(root.dir,'Data/2022_09_29', paste0(level, '.RData')))
  meta.dat$SubjectID <- gsub('WWV54','WVW54',meta.dat$SubjectID)
  
  if(subsetBRAF ==T){
    meta.dat <- meta.dat[meta.dat$file_name !="20201028_AG489_C1" & meta.dat$BRAF == BRAF.sub,]
  }else{
    meta.dat <- meta.dat[meta.dat$file_name !="20201028_AG489_C1", ]
  }
  cell.count <- cell.count[meta.dat$file_name,,drop =F]
  cell.freq <- cell.freq[meta.dat$file_name,,drop =F]
  # cell.count <- cell.count[,unique(BTNK[,tolower(level)])]
  ## cell.diff.obj 
  cell.count0 <- cell.count + 0.5
  size.factor <- rowSums(cell.count0)
  cell.freq <- cell.count0 / size.factor
  cell.freq.base <- cell.freq[meta.dat[meta.dat$TimePoint == 'BASELINE','file_name'], ]
  rownames(cell.freq.base) <- gsub("^([^_]*_[^_]*)_.*$", "\\1", rownames(cell.freq.base))
  base.name <- rownames(cell.freq.base)
  cell.freq.diff <- names <- NULL
  for(k in c('BASELINE','C1','C3','C4')){
    cell.time <- cell.freq[meta.dat[meta.dat$TimePoint == k,'file_name'], ]
    names <- c(names, rownames(cell.time))
    rownames(cell.time) <- gsub("^([^_]*_[^_]*)_.*$", "\\1", rownames(cell.time))
    cell.freq.diff <- rbind(cell.freq.diff, cell.time/cell.freq.base[rownames(cell.time),])
  }
  rownames(cell.freq.diff) <- names
  cell.freq.diff <- log2(cell.freq.diff) #log fold change from the baseline
  # cell.freq.diff.sqrt <- sign(cell.freq.diff) * sqrt(abs(cell.freq.diff ))
  
  cell.count.filter <- cell.count[,colSums(cell.count) > 0]
  cell.diff.obj[[paste0('level', i)]] <- cell.freq.diff[,colnames(cell.count.filter)]
  # cell.abund.obj[[paste0('level', i)]] <- cell.count
  cell.abund.obj[[paste0('level', i)]] <- cell.count.filter
  cell.prop.obj[[paste0('level', i)]] <- cell.freq[,colnames(cell.count)] # not filtered , all cells
}
names(cell.abund.obj) <- names(cell.prop.obj) <- names(cell.diff.obj)  <- c('Compartment','Assignment','Profiling')

meta.samples <- meta.dat[,c('file_name','TimePoint','BRAF','PR2','RunDate','patient_id','PR2.n','PR4.n')] %>% dplyr::rename(SubjectID = patient_id)
colnames(meta.samples)[1] <- 'sam.ids'
meta.samples$PR2.n <- as.factor(meta.samples$PR2.n)
meta.samples$PR4.n <- as.factor(meta.samples$PR4.n)
meta.samples <- within(meta.samples, BRAF <- relevel(BRAF, ref = 1))
meta.samples <- within(meta.samples, PR2 <- relevel(PR2, ref = 1))
```

### DAA: CD8+ T Cell (Central Memory)
```{r echo=F, error=TRUE, fig.height=4, fig.retina=4, fig.width=6, message=FALSE, warning=FALSE, include=T, results="asis"}
load('/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022_09_13/Anno.RData')
CD8TCM = anno[anno$assignment == "CD8+ T Cell (Central Memory)",'profiling']
CD4TEM = anno[anno$assignment == "CD4+ T Cell (Effector Memory)",'profiling']
cell.prop.obj$CD8TCM <- cell.prop.obj$Profiling[,CD8TCM]
cell.prop.obj$CD4TEM <- cell.prop.obj$Profiling[,CD4TEM]
dir.l1 <- '/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Result/2022_12_14_FinalSummary/DAA/'

ree <- NULL
ree <- run(cell.obj = cell.prop.obj, cell.plot.obj = cell.prop.obj, dir.l1 = dir.l1,dir.l2 = 'mean_observed', 
           cell.levels = 'CD8TCM',timepoints =c('BASELINE','C1','C3','C4'),
           transform = 'asinhsqrt',
           feature.dat.type = 'other', filter = F, method = 'lm', subsetBRAF = subsetBRAF, BRAF.sub = BRAF.sub,
           meta.samples = meta.samples, grp.name = grp.name, adj.name = adj.name)

res <- ree$tb[,c('cells','pvalue','time')] %>% spread(time, pvalue) %>%  column_to_rownames('cells')
res0 <- t(res)
reactable(res %>% dplyr::rename_with( ~ paste0(.x,"(p)")) %>% rownames_to_column('celltypes'), pageSizeOptions = 10, pagination = T, filterable = TRUE)
```

```{r echo=F, error=TRUE, fig.height=3, fig.retina=4, fig.width=6, message=FALSE, warning=FALSE, include=T, results="asis"}
plt <- list()
for(celltype in c(CD8TCM)){
  data <- as.data.frame(cell.prop.obj$CD8TCM[,c(celltype), drop =F]) %>% rownames_to_column('sam.ids')
  meta.tmp <- meta.samples[,c('sam.ids','TimePoint','PR4.n')]
  colnames(meta.tmp)[3] <- 'Response'
  data1 <- full_join(data, meta.tmp) 
  p <- as.data.frame(res0[,celltype,drop =F])%>% rownames_to_column('TimePoint')
  colnames(p)[2] <- 'p'
  data2 <- data1 %>% left_join(p)
  data2$TimePoint <- paste0(data2$TimePoint, '(p=',data2$p,')')
  
  plt[[celltype]] <- ggplot(data2, aes(y = (!!as.name(celltype))*100, x = Response, color =!!as.name('Response'))) +
    geom_boxplot() +
    geom_jitter(position = position_jitterdodge(0.5)) +
    facet_wrap(~TimePoint, nrow =1) +
    scale_color_brewer(palette = 'Set1') +
    theme_bw() +
    theme(axis.title = element_text(size = 12),
          axis.text = element_text(size = 12, color = 'black'),
          legend.position = 'none',
          plot.title = element_text(hjust = 0.5,size = 10)) +
    labs(x = '', y = '% of total cells') +
    ggtitle(celltype)
}

# pdf(paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/CD8TCM_profiling_",BRAF.sub,".pdf"), width = 8, height = 4)
for(i in 1:length(plt)){
    print(plt[[i]])
  }
# dev.off()
```

### DAA: CD4+ T Cell (Effector Memory)

```{r echo=F, error=TRUE, fig.height=4, fig.retina=4, fig.width=6, message=FALSE, warning=FALSE, include=T, results="asis"}
ree <- NULL
ree <- run(cell.obj = cell.prop.obj, cell.plot.obj = cell.prop.obj, dir.l1 = dir.l1,dir.l2 = 'mean_observed', 
           cell.levels = 'CD4TEM',timepoints =c('BASELINE','C1','C3','C4'),
           transform = 'asinhsqrt',
           feature.dat.type = 'other', filter = F, method = 'lm', subsetBRAF = subsetBRAF, BRAF.sub = BRAF.sub,
           meta.samples = meta.samples, grp.name = grp.name, adj.name = adj.name)

res <- ree$tb[,c('cells','pvalue','time')] %>% spread(time, pvalue) %>%  column_to_rownames('cells')
res0 <- t(res)
reactable(res %>% dplyr::rename_with( ~ paste0(.x,"(p)")) %>% rownames_to_column('celltypes'), pageSizeOptions = 10, pagination = T, filterable = TRUE)
```

```{r echo=F, error=TRUE, fig.height=3, fig.retina=4, fig.width=6, message=FALSE, warning=FALSE, include=T, results="asis"}
plt <- list()
for(celltype in c(CD4TEM)){
  data <- as.data.frame(cell.prop.obj$CD4TEM[,c(celltype), drop =F]) %>% rownames_to_column('sam.ids')
  meta.tmp <- meta.samples[,c('sam.ids','TimePoint','PR4.n')]
  colnames(meta.tmp)[3] <- 'Response'
  data1 <- full_join(data, meta.tmp) 
  p <- as.data.frame(res0[,celltype,drop =F])%>% rownames_to_column('TimePoint')
  colnames(p)[2] <- 'p'
  data2 <- data1 %>% left_join(p)
  data2$TimePoint <- paste0(data2$TimePoint, '(p=',data2$p,')')
  
  plt[[celltype]] <- ggplot(data2, aes(y = (!!as.name(celltype))*100, x = Response, color =!!as.name('Response'))) +
    geom_boxplot() +
    geom_jitter(position = position_jitterdodge(0.5)) +
    facet_wrap(~TimePoint, nrow =1) +
    scale_color_brewer(palette = 'Set1') +
    theme_bw() +
    theme(axis.title = element_text(size = 12),
          axis.text = element_text(size = 12, color = 'black'),
          legend.position = 'none',
          plot.title = element_text(hjust = 0.5,size = 10)) +
    labs(x = '', y = '% of total cells') +
    ggtitle(celltype)
}

# pdf(paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/CD4TEM_profiling_",BRAF.sub,".pdf"), width = 8, height = 4)
for(i in 1:length(plt)){
    print(plt[[i]])
  }
# dev.off()
```

```{r echo=F, error=TRUE, fig.height=4, fig.retina=4, fig.width=6, message=FALSE, warning=FALSE, include=T, results="asis"}
## exclude outlier sample
level <- 'Profiling'
tmp <- load(paste0("/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022/agg_trans/",level,".RData"))
meta.dat$SubjectID <- gsub('WWV54','WVW54',meta.dat$SubjectID)

if(subsetBRAF == T){
  meta.samples <- meta.samples[meta.samples$sam.ids != "20201028_AG489_C1" & meta.samples$BRAF == BRAF.sub,,drop =F]
}else{
  meta.samples <- meta.samples[meta.samples$sam.ids != "20201028_AG489_C1" ,,drop =F]
}

files <- meta.samples$sam.ids
cell.marker.mean0 <- cell.marker.cvs0 <- cell.marker.median0 <- cell.marker.90qt0 <- cell.marker.99qt0 <- 
  array(NA, c(length(files), length(dimnames(cell.marker.mean)[[2]]), length(dimnames(cell.marker.mean)[[3]])), 
        dimnames = list(files, dimnames(cell.marker.mean)[[2]],dimnames(cell.marker.mean)[[3]]))
for(file in files){
  cell.marker.mean0[file,,] <- cell.marker.mean[file,,] 
  cell.marker.median0[file,,] <- cell.marker.median[file,,] 
  cell.marker.cvs0[file,,] <- cell.marker.cvs[file,,] 
  cell.marker.90qt0[file,,] <- cell.marker.90qt[file,,] 
  cell.marker.99qt0[file,,] <- cell.marker.99qt[file,,] 
}

cell.marker.mean <- cell.marker.mean0
cell.marker.median <- cell.marker.median0
cell.marker.90qt <- cell.marker.90qt0
cell.marker.99qt <- cell.marker.99qt0

### log fold change from baseline
cell.marker.90qt.lfc <- lfc.func(cell.marker = cell.marker.90qt)$cell.marker.lfc
cell.marker.90qt.diff.sqrt <- lfc.func(cell.marker = cell.marker.90qt)$cell.marker.diff.sqrt
cell.marker.mean.lfc <- lfc.func(cell.marker = cell.marker.mean)$cell.marker.lfc

## aggregate CD4+ or CD8+ cells 
level = 'Profiling'
tmp <- load(paste0("/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022/agg_trans/",level,".RData"))
meta.dat$SubjectID <- gsub('WWV54','WVW54',meta.dat$SubjectID)

if(subsetBRAF == T){
  meta.samples <- meta.samples[meta.samples$sam.ids != "20201028_AG489_C1" & meta.samples$BRAF == BRAF.sub,,drop =F]
}else{
  meta.samples <- meta.samples[meta.samples$sam.ids != "20201028_AG489_C1" ,,drop =F]
}

files <- meta.samples$sam.ids
celltypes.CD4 <- unique(BTNK[,tolower(level)])[grep('^CD4\\+\\ T',unique(BTNK[,tolower(level)]))]
celltypes.CD8 <- unique(BTNK[,tolower(level)])[grep('^CD8\\+\\ T',unique(BTNK[,tolower(level)]))]

cell.marker.mean1 <- cell.marker.cvs1 <- cell.marker.median1 <- cell.marker.90qt1 <- cell.marker.99qt1 <- 
  array(NA, c(length(files), 2, length(dimnames(cell.marker.mean)[[3]])), 
        dimnames = list(files, c('CD4+','CD8+'),dimnames(cell.marker.mean)[[3]]))
for(file in files){
  tmp1 <- as.data.frame(cell.marker.mean[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  tmp2 <- as.data.frame(cell.marker.median[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  tmp3 <- as.data.frame(cell.marker.cvs[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  tmp4 <- as.data.frame(cell.marker.90qt[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  tmp5 <- as.data.frame(cell.marker.99qt[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  cell.marker.mean1[file,,] <- tmp1
  cell.marker.median1[file,,] <- tmp2
  cell.marker.cvs1[file,,] <- tmp3
  cell.marker.90qt1[file,,] <- tmp4
  cell.marker.99qt1[file,,] <- tmp5
}

cell.marker.mean.agg <- cell.marker.mean1
cell.marker.median.agg <- cell.marker.median1
cell.marker.90qt.agg <- cell.marker.90qt1
cell.marker.99qt.agg <- cell.marker.99qt1

cell.marker.90qt.agg.lfc <- lfc.func(cell.marker = cell.marker.90qt.agg)$cell.marker.lfc
cell.marker.90qt.agg.diff.sqrt <- lfc.func(cell.marker = cell.marker.90qt.agg)$cell.marker.diff.sqrt
cell.marker.mean.agg.lfc <- lfc.func(cell.marker = cell.marker.mean.agg)$cell.marker.lfc
```

### DEA: CD8+ T Cell (Central Memory)
```{r echo=F, error=TRUE, fig.height=4, fig.retina=4, fig.width=6, message=FALSE, warning=FALSE, include=T, results="asis"}
load('/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022_09_13/Anno.RData')
CD8TCM = anno[anno$assignment == "CD8+ T Cell (Central Memory)",'profiling']
CD4TEM = anno[anno$assignment == "CD4+ T Cell (Effector Memory)",'profiling']

## CD8+TCM and CD4+ T Cell (Effector Memory)
dea.res1 <- NULL
dea.res1 <- perform_DEA_CyTOF(data = cell.marker.mean, celltypes = c(CD8TCM,CD4TEM), 
                              sam.col = 'sam.ids', method = 'lm',transform = 'log2',
                              BRAF.sub =BRAF.sub, subsetBRAF = subsetBRAF,
                              meta.dat = meta.samples, timepoints = c('BASELINE','C1','C3','C4'), 
                              variables = grp.name,adj.name = adj.name)
tb <- dea2tb(dea.res1)
res <- tb$tb[,c(1:2,4,7,10,13)] 
res$group <- 'CD8+ T cell'
res[res$celltypes %in% res$celltypes[grep('^CD4',res$celltypes)],'group'] <- 'CD4+ T cell'
reactable(res[res$celltypes %in% CD8TCM,], pageSizeOptions = 10, pagination = T, filterable = TRUE,
          columns = list(celltypes = colDef(minWidth = 300), markers = colDef(minWidth = 200)))
res0 <- t(res)
# write.csv(res, file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/CD8+TCM_CD4TEM_Profiling[mean]DEA_",BRAF.sub,".csv"), row.names = F)
```

```{r echo=F, error=TRUE, fig.height=3, fig.retina=4, fig.width=7, message=FALSE, warning=FALSE, include=T, results="asis"}
data_summary <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,varname)
  data_sum <- rename(data_sum, c("mean" = varname))
  return(data_sum)
}

for(celltype in unique(res[res$group=='CD8+ T cell','celltypes'])){
  # pdf(paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/",BRAF.sub,'_',celltype,".pdf"), width =8, height = 4)
  CD8.df <- (cell.marker.mean[,celltype,])
  CD8.df <- log2(CD8.df)
  
  plt <- plt1 <- list()
  for(marker in unique(res$markers)){
    plt.df <- inner_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                        meta.samples[,c('sam.ids','PR4.n','TimePoint')])
    colnames(plt.df)[2] <- 'marker'
    colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
    
    plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
    plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
      geom_line() +
      geom_point()+
      geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
      theme_classic() + 
      theme(plot.title = element_text(hjust = 0.5,size = 8),
            axis.text = element_text(size = 12, color = 'black'),
            axis.title = element_text(size = 12, color = 'black'),
            legend.text = element_text(size = 12, color = 'black'),
            legend.title = element_text(size = 12, color = 'black')) + 
      labs(y = 'log2 (mean abundance)') + 
      ggtitle(paste0(marker,'(',celltype, ')'))
    CD8.tmp <- res[res$celltypes==celltype,] %>% dplyr::select(-c('group'))
    colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
    rownames(CD8.tmp) <- NULL
    CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
    colnames(CD8.tmp)[2] <- 'p'
    plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
    plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
      geom_boxplot() + 
      geom_jitter(position = position_jitterdodge(0.5)) +
      theme_classic() + 
      theme(plot.title = element_text(hjust = 0.5,size = 10),
            axis.text = element_text(size = 12, color = 'black'),
            axis.title = element_text(size = 12, color = 'black'),
            legend.text = element_text(size = 12, color = 'black'),
            legend.title = element_text(size = 12, color = 'black')) + 
      labs(y = 'log2 (mean abundance)') + 
      ggtitle(paste0(marker,'(',celltype, ')'))
    
  }
  for(i in 1:length(plt1)){
    print(plt1[[i]])
  }
  # dev.off()
}
```

### DEA: CD4+ T Cell (Effector Memory)
```{r echo=F, error=TRUE, fig.height=3, fig.retina=4, fig.width=7, message=FALSE, warning=FALSE, include=T, results="asis"}
reactable(res[res$celltypes %in% CD4TEM,], pageSizeOptions = 10, pagination = T, filterable = TRUE,
          columns = list(celltypes = colDef(minWidth = 300), markers = colDef(minWidth = 200)))

data_summary <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,varname)
  data_sum <- rename(data_sum, c("mean" = varname))
  return(data_sum)
}
for(celltype in unique(res[res$group=='CD4+ T cell','celltypes'])){
  # pdf(paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/",BRAF.sub,'_',celltype,".pdf"), width =8, height = 4)
  CD8.df <- (cell.marker.mean[,celltype,])
  CD8.df <- log2(CD8.df)
  
  plt <- plt1 <- list()
  for(marker in unique(res$markers)){
    plt.df <- inner_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                        meta.samples[,c('sam.ids','PR4.n','TimePoint')])
    colnames(plt.df)[2] <- 'marker'
    colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
    plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
    plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
      geom_line() +
      geom_point()+
      geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
      theme_classic() + 
      theme(plot.title = element_text(hjust = 0.5,size = 8),
            axis.text = element_text(size = 12, color = 'black'),
            axis.title = element_text(size = 12, color = 'black'),
            legend.text = element_text(size = 12, color = 'black'),
            legend.title = element_text(size = 12, color = 'black')) + 
      labs(y = 'log2 (mean abundance)') + 
      ggtitle(paste0(marker,'(',celltype, ')'))
    CD8.tmp <- res[res$celltypes==celltype,] %>% dplyr::select(-c('group'))
    colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
    rownames(CD8.tmp) <- NULL
    CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
    colnames(CD8.tmp)[2] <- 'p'
    plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
    plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
      geom_boxplot() + 
      geom_jitter(position = position_jitterdodge(0.5)) +
      theme_classic() + 
      theme(plot.title = element_text(hjust = 0.5,size = 10),
            axis.text = element_text(size = 12, color = 'black'),
            axis.title = element_text(size = 12, color = 'black'),
            legend.text = element_text(size = 12, color = 'black'),
            legend.title = element_text(size = 12, color = 'black')) + 
      labs(y = 'log2 (mean abundance)') + 
      ggtitle(paste0(marker,'(',celltype, ')'))
    
  }
  
  for(i in 1:length(plt1)){
    print(plt1[[i]])
  }
  
  # dev.off()
}
```


## 2.Within BRAFwt

```{r, message=FALSE, message=F, warning=F, echo=FALSE, results='hide'}
grp.name= 'PR4.n'
adj.name= NULL
subsetBRAF= TRUE
BRAF.sub='BRAFwt'
```

```{r, message=FALSE, message=F, warning=F, echo=FALSE, results='hide'}
source(paste0(root.dir,'Code/Stats.R'))
source(paste0(root.dir,'Code/Func.R'))

cell.abund.obj <- cell.prop.obj <- cell.diff.obj <- list()
i = 0
for(level in c('Compartment','Assignment','Profiling')){
  i = i + 1
  output <- paste0(root.dir,'Result/',level)
  load(file.path(root.dir,'Data/2022_09_29', paste0(level, '.RData')))
  meta.dat$SubjectID <- gsub('WWV54','WVW54',meta.dat$SubjectID)
  
  if(subsetBRAF ==T){
    meta.dat <- meta.dat[meta.dat$file_name !="20201028_AG489_C1" & meta.dat$BRAF == BRAF.sub,]
  }else{
    meta.dat <- meta.dat[meta.dat$file_name !="20201028_AG489_C1", ]
  }
  cell.count <- cell.count[meta.dat$file_name,,drop =F]
  cell.freq <- cell.freq[meta.dat$file_name,,drop =F]
  # cell.count <- cell.count[,unique(BTNK[,tolower(level)])]
  ## cell.diff.obj 
  cell.count0 <- cell.count + 0.5
  size.factor <- rowSums(cell.count0)
  cell.freq <- cell.count0 / size.factor
  cell.freq.base <- cell.freq[meta.dat[meta.dat$TimePoint == 'BASELINE','file_name'], ]
  rownames(cell.freq.base) <- gsub("^([^_]*_[^_]*)_.*$", "\\1", rownames(cell.freq.base))
  base.name <- rownames(cell.freq.base)
  cell.freq.diff <- names <- NULL
  for(k in c('BASELINE','C1','C3','C4')){
    cell.time <- cell.freq[meta.dat[meta.dat$TimePoint == k,'file_name'], ]
    names <- c(names, rownames(cell.time))
    rownames(cell.time) <- gsub("^([^_]*_[^_]*)_.*$", "\\1", rownames(cell.time))
    cell.freq.diff <- rbind(cell.freq.diff, cell.time/cell.freq.base[rownames(cell.time),])
  }
  rownames(cell.freq.diff) <- names
  cell.freq.diff <- log2(cell.freq.diff) #log fold change from the baseline
  # cell.freq.diff.sqrt <- sign(cell.freq.diff) * sqrt(abs(cell.freq.diff ))
  
  cell.count.filter <- cell.count[,colSums(cell.count) > 0]
  cell.diff.obj[[paste0('level', i)]] <- cell.freq.diff[,colnames(cell.count.filter)]
  # cell.abund.obj[[paste0('level', i)]] <- cell.count
  cell.abund.obj[[paste0('level', i)]] <- cell.count.filter
  cell.prop.obj[[paste0('level', i)]] <- cell.freq[,colnames(cell.count)] # not filtered , all cells
}
names(cell.abund.obj) <- names(cell.prop.obj) <- names(cell.diff.obj)  <- c('Compartment','Assignment','Profiling')

meta.samples <- meta.dat[,c('file_name','TimePoint','BRAF','PR2','RunDate','patient_id','PR2.n','PR4.n')] %>% dplyr::rename(SubjectID = patient_id)
colnames(meta.samples)[1] <- 'sam.ids'
meta.samples$PR2.n <- as.factor(meta.samples$PR2.n)
meta.samples$PR4.n <- as.factor(meta.samples$PR4.n)
meta.samples <- within(meta.samples, BRAF <- relevel(BRAF, ref = 1))
meta.samples <- within(meta.samples, PR2 <- relevel(PR2, ref = 1))
```

### DAA: CD8+ T Cell (Central Memory)
```{r echo=F, error=TRUE, fig.height=4, fig.retina=4, fig.width=6, message=FALSE, warning=FALSE, include=T, results="asis"}
load('/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022_09_13/Anno.RData')
CD8TCM = anno[anno$assignment == "CD8+ T Cell (Central Memory)",'profiling']
CD4TEM = anno[anno$assignment == "CD4+ T Cell (Effector Memory)",'profiling']
cell.prop.obj$CD8TCM <- cell.prop.obj$Profiling[,CD8TCM]
cell.prop.obj$CD4TEM <- cell.prop.obj$Profiling[,CD4TEM]
dir.l1 <- '/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Result/2022_12_14_FinalSummary/DAA/'

ree <- NULL
ree <- run(cell.obj = cell.prop.obj, cell.plot.obj = cell.prop.obj, dir.l1 = dir.l1,dir.l2 = 'mean_observed', 
           cell.levels = 'CD8TCM',timepoints =c('BASELINE','C1','C3','C4'),
           transform = 'asinhsqrt',
           feature.dat.type = 'other', filter = F, method = 'lm', subsetBRAF = subsetBRAF, BRAF.sub = BRAF.sub,
           meta.samples = meta.samples, grp.name = grp.name, adj.name = adj.name)

res <- ree$tb[,c('cells','pvalue','time')] %>% spread(time, pvalue) %>%  column_to_rownames('cells')
res0 <- t(res)
reactable(res %>% dplyr::rename_with( ~ paste0(.x,"(p)")) %>% rownames_to_column('celltypes'), pageSizeOptions = 10, pagination = T, filterable = TRUE)
```

```{r echo=F, error=TRUE, fig.height=3, fig.retina=4, fig.width=6, message=FALSE, warning=FALSE, include=T, results="asis"}
plt <- list()
for(celltype in c(CD8TCM)){
  data <- as.data.frame(cell.prop.obj$CD8TCM[,c(celltype), drop =F]) %>% rownames_to_column('sam.ids')
  meta.tmp <- meta.samples[,c('sam.ids','TimePoint','PR4.n')]
  colnames(meta.tmp)[3] <- 'Response'
  data1 <- full_join(data, meta.tmp) 
  p <- as.data.frame(res0[,celltype,drop =F])%>% rownames_to_column('TimePoint')
  colnames(p)[2] <- 'p'
  data2 <- data1 %>% left_join(p)
  data2$TimePoint <- paste0(data2$TimePoint, '(p=',data2$p,')')
  
  plt[[celltype]] <- ggplot(data2, aes(y = (!!as.name(celltype))*100, x = Response, color =!!as.name('Response'))) +
    geom_boxplot() +
    geom_jitter(position = position_jitterdodge(0.5)) +
    facet_wrap(~TimePoint, nrow =1) +
    scale_color_brewer(palette = 'Set1') +
    theme_bw() +
    theme(axis.title = element_text(size = 12),
          axis.text = element_text(size = 12, color = 'black'),
          legend.position = 'none',
          plot.title = element_text(hjust = 0.5,size = 10)) +
    labs(x = '', y = '% of total cells') +
    ggtitle(celltype)
}

# pdf(paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/CD8TCM_profiling_",BRAF.sub,".pdf"), width = 8, height = 4)
for(i in 1:length(plt)){
    print(plt[[i]])
  }
# dev.off()
```

### DAA: CD4+ T Cell (Effector Memory)

```{r echo=F, error=TRUE, fig.height=4, fig.retina=4, fig.width=6, message=FALSE, warning=FALSE, include=T, results="asis"}
ree <- NULL
ree <- run(cell.obj = cell.prop.obj, cell.plot.obj = cell.prop.obj, dir.l1 = dir.l1,dir.l2 = 'mean_observed', 
           cell.levels = 'CD4TEM',timepoints =c('BASELINE','C1','C3','C4'),
           transform = 'asinhsqrt',
           feature.dat.type = 'other', filter = F, method = 'lm', subsetBRAF = subsetBRAF, BRAF.sub = BRAF.sub,
           meta.samples = meta.samples, grp.name = grp.name, adj.name = adj.name)

res <- ree$tb[,c('cells','pvalue','time')] %>% spread(time, pvalue) %>%  column_to_rownames('cells')
res0 <- t(res)
reactable(res %>% dplyr::rename_with( ~ paste0(.x,"(p)")) %>% rownames_to_column('celltypes'), pageSizeOptions = 10, pagination = T, filterable = TRUE)
```

```{r echo=F, error=TRUE, fig.height=3, fig.retina=4, fig.width=6, message=FALSE, warning=FALSE, include=T, results="asis"}
plt <- list()
for(celltype in c(CD4TEM)){
  data <- as.data.frame(cell.prop.obj$CD4TEM[,c(celltype), drop =F]) %>% rownames_to_column('sam.ids')
  meta.tmp <- meta.samples[,c('sam.ids','TimePoint','PR4.n')]
  colnames(meta.tmp)[3] <- 'Response'
  data1 <- full_join(data, meta.tmp) 
  p <- as.data.frame(res0[,celltype,drop =F])%>% rownames_to_column('TimePoint')
  colnames(p)[2] <- 'p'
  data2 <- data1 %>% left_join(p)
  data2$TimePoint <- paste0(data2$TimePoint, '(p=',data2$p,')')
  
  plt[[celltype]] <- ggplot(data2, aes(y = (!!as.name(celltype))*100, x = Response, color =!!as.name('Response'))) +
    geom_boxplot() +
    geom_jitter(position = position_jitterdodge(0.5)) +
    facet_wrap(~TimePoint, nrow =1) +
    scale_color_brewer(palette = 'Set1') +
    theme_bw() +
    theme(axis.title = element_text(size = 12),
          axis.text = element_text(size = 12, color = 'black'),
          legend.position = 'none',
          plot.title = element_text(hjust = 0.5,size = 10)) +
    labs(x = '', y = '% of total cells') +
    ggtitle(celltype)
}

# pdf(paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/CD4TEM_profiling_",BRAF.sub,".pdf"), width = 8, height = 4)
for(i in 1:length(plt)){
    print(plt[[i]])
  }
# dev.off()
```

```{r echo=F, error=TRUE, fig.height=4, fig.retina=4, fig.width=6, message=FALSE, warning=FALSE, include=T, results="asis"}
## exclude outlier sample
level <- 'Profiling'
tmp <- load(paste0("/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022/agg_trans/",level,".RData"))
meta.dat$SubjectID <- gsub('WWV54','WVW54',meta.dat$SubjectID)

if(subsetBRAF == T){
  meta.samples <- meta.samples[meta.samples$sam.ids != "20201028_AG489_C1" & meta.samples$BRAF == BRAF.sub,,drop =F]
}else{
  meta.samples <- meta.samples[meta.samples$sam.ids != "20201028_AG489_C1" ,,drop =F]
}

files <- meta.samples$sam.ids
cell.marker.mean0 <- cell.marker.cvs0 <- cell.marker.median0 <- cell.marker.90qt0 <- cell.marker.99qt0 <- 
  array(NA, c(length(files), length(dimnames(cell.marker.mean)[[2]]), length(dimnames(cell.marker.mean)[[3]])), 
        dimnames = list(files, dimnames(cell.marker.mean)[[2]],dimnames(cell.marker.mean)[[3]]))
for(file in files){
  cell.marker.mean0[file,,] <- cell.marker.mean[file,,] 
  cell.marker.median0[file,,] <- cell.marker.median[file,,] 
  cell.marker.cvs0[file,,] <- cell.marker.cvs[file,,] 
  cell.marker.90qt0[file,,] <- cell.marker.90qt[file,,] 
  cell.marker.99qt0[file,,] <- cell.marker.99qt[file,,] 
}

cell.marker.mean <- cell.marker.mean0
cell.marker.median <- cell.marker.median0
cell.marker.90qt <- cell.marker.90qt0
cell.marker.99qt <- cell.marker.99qt0

### log fold change from baseline
cell.marker.90qt.lfc <- lfc.func(cell.marker = cell.marker.90qt)$cell.marker.lfc
cell.marker.90qt.diff.sqrt <- lfc.func(cell.marker = cell.marker.90qt)$cell.marker.diff.sqrt
cell.marker.mean.lfc <- lfc.func(cell.marker = cell.marker.mean)$cell.marker.lfc

## aggregate CD4+ or CD8+ cells 
level = 'Profiling'
tmp <- load(paste0("/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022/agg_trans/",level,".RData"))
meta.dat$SubjectID <- gsub('WWV54','WVW54',meta.dat$SubjectID)

if(subsetBRAF == T){
  meta.samples <- meta.samples[meta.samples$sam.ids != "20201028_AG489_C1" & meta.samples$BRAF == BRAF.sub,,drop =F]
}else{
  meta.samples <- meta.samples[meta.samples$sam.ids != "20201028_AG489_C1" ,,drop =F]
}

files <- meta.samples$sam.ids
celltypes.CD4 <- unique(BTNK[,tolower(level)])[grep('^CD4\\+\\ T',unique(BTNK[,tolower(level)]))]
celltypes.CD8 <- unique(BTNK[,tolower(level)])[grep('^CD8\\+\\ T',unique(BTNK[,tolower(level)]))]

cell.marker.mean1 <- cell.marker.cvs1 <- cell.marker.median1 <- cell.marker.90qt1 <- cell.marker.99qt1 <- 
  array(NA, c(length(files), 2, length(dimnames(cell.marker.mean)[[3]])), 
        dimnames = list(files, c('CD4+','CD8+'),dimnames(cell.marker.mean)[[3]]))
for(file in files){
  tmp1 <- as.data.frame(cell.marker.mean[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  tmp2 <- as.data.frame(cell.marker.median[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  tmp3 <- as.data.frame(cell.marker.cvs[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  tmp4 <- as.data.frame(cell.marker.90qt[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  tmp5 <- as.data.frame(cell.marker.99qt[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  cell.marker.mean1[file,,] <- tmp1
  cell.marker.median1[file,,] <- tmp2
  cell.marker.cvs1[file,,] <- tmp3
  cell.marker.90qt1[file,,] <- tmp4
  cell.marker.99qt1[file,,] <- tmp5
}

cell.marker.mean.agg <- cell.marker.mean1
cell.marker.median.agg <- cell.marker.median1
cell.marker.90qt.agg <- cell.marker.90qt1
cell.marker.99qt.agg <- cell.marker.99qt1

cell.marker.90qt.agg.lfc <- lfc.func(cell.marker = cell.marker.90qt.agg)$cell.marker.lfc
cell.marker.90qt.agg.diff.sqrt <- lfc.func(cell.marker = cell.marker.90qt.agg)$cell.marker.diff.sqrt
cell.marker.mean.agg.lfc <- lfc.func(cell.marker = cell.marker.mean.agg)$cell.marker.lfc
```


### DEA: CD8+ T Cell (Central Memory)

```{r echo=F, error=TRUE, fig.height=4, fig.retina=4, fig.width=6, message=FALSE, warning=FALSE, include=T, results="asis"}
load('/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022_09_13/Anno.RData')
CD8TCM = anno[anno$assignment == "CD8+ T Cell (Central Memory)",'profiling']
CD4TEM = anno[anno$assignment == "CD4+ T Cell (Effector Memory)",'profiling']

## CD8+TCM and CD4+ T Cell (Effector Memory)
dea.res1 <- NULL
dea.res1 <- perform_DEA_CyTOF(data = cell.marker.mean, celltypes = c(CD8TCM,CD4TEM), 
                              sam.col = 'sam.ids', method = 'lm',transform = 'log2',
                              BRAF.sub =BRAF.sub, subsetBRAF = subsetBRAF,
                              meta.dat = meta.samples, timepoints = c('BASELINE','C1','C3','C4'), 
                              variables = grp.name,adj.name = adj.name)
tb <- dea2tb(dea.res1)
res <- tb$tb[,c(1:2,4,7,10,13)] 
res$group <- 'CD8+ T cell'
res[res$celltypes %in% res$celltypes[grep('^CD4',res$celltypes)],'group'] <- 'CD4+ T cell'
reactable(res[res$celltypes %in% CD8TCM,], pageSizeOptions = 10, pagination = T, filterable = TRUE,
          columns = list(celltypes = colDef(minWidth = 300), markers = colDef(minWidth = 200)))
res0 <- t(res)
# write.csv(res, file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/CD8+TCM_CD4TEM_Profiling[mean]DEA_",BRAF.sub,".csv"), row.names = F)
```


```{r echo=F, error=TRUE, fig.height=3, fig.retina=4, fig.width=7, message=FALSE, warning=FALSE, include=T, results="asis"}
data_summary <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,varname)
  data_sum <- rename(data_sum, c("mean" = varname))
  return(data_sum)
}

for(celltype in unique(res[res$group=='CD8+ T cell','celltypes'])){
  # pdf(paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/",BRAF.sub,'_',celltype,".pdf"), width =8, height = 4)
  CD8.df <- (cell.marker.mean[,celltype,])
  CD8.df <- log2(CD8.df)
  
  plt <- plt1 <- list()
  for(marker in unique(res$markers)){
    plt.df <- inner_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                        meta.samples[,c('sam.ids','PR4.n','TimePoint')])
    colnames(plt.df)[2] <- 'marker'
    colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
    plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
    plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
      geom_line() +
      geom_point()+
      geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
      theme_classic() + 
      theme(plot.title = element_text(hjust = 0.5,size = 8),
            axis.text = element_text(size = 12, color = 'black'),
            axis.title = element_text(size = 12, color = 'black'),
            legend.text = element_text(size = 12, color = 'black'),
            legend.title = element_text(size = 12, color = 'black')) + 
      labs(y = 'log2 (mean abundance)') + 
      ggtitle(paste0(marker,'(',celltype, ')'))
    CD8.tmp <- res[res$celltypes==celltype,] %>% dplyr::select(-c('group'))
    colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
    rownames(CD8.tmp) <- NULL
    CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
    colnames(CD8.tmp)[2] <- 'p'
    plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
    plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
      geom_boxplot() + 
      geom_jitter(position = position_jitterdodge(0.5)) +
      theme_classic() + 
      theme(plot.title = element_text(hjust = 0.5,size = 10),
            axis.text = element_text(size = 12, color = 'black'),
            axis.title = element_text(size = 12, color = 'black'),
            legend.text = element_text(size = 12, color = 'black'),
            legend.title = element_text(size = 12, color = 'black')) + 
      labs(y = 'log2 (mean abundance)') + 
      ggtitle(paste0(marker,'(',celltype, ')'))
    
  }
  for(i in 1:length(plt1)){
    print(plt1[[i]])
  }
  # dev.off()
}
```


### DEA: CD4+ T Cell (Effector Memory)
```{r echo=F, error=TRUE, fig.height=3, fig.retina=4, fig.width=7, message=FALSE, warning=FALSE, include=T, results="asis"}
reactable(res[res$celltypes %in% CD4TEM,], pageSizeOptions = 10, pagination = T, filterable = TRUE,
          columns = list(celltypes = colDef(minWidth = 300), markers = colDef(minWidth = 200)))
data_summary <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,varname)
  data_sum <- rename(data_sum, c("mean" = varname))
  return(data_sum)
}

for(celltype in unique(res[res$group=='CD4+ T cell','celltypes'])){
  # pdf(paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/",BRAF.sub,'_',celltype,".pdf"), width =8, height = 4)
  CD8.df <- (cell.marker.mean[,celltype,])
  CD8.df <- log2(CD8.df)
  
  plt <- plt1 <- list()
  for(marker in unique(res$markers)){
    plt.df <- inner_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                        meta.samples[,c('sam.ids','PR4.n','TimePoint')])
    colnames(plt.df)[2] <- 'marker'
    colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
    plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
    plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
      geom_line() +
      geom_point()+
      geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
      theme_classic() + 
      theme(plot.title = element_text(hjust = 0.5,size = 8),
            axis.text = element_text(size = 12, color = 'black'),
            axis.title = element_text(size = 12, color = 'black'),
            legend.text = element_text(size = 12, color = 'black'),
            legend.title = element_text(size = 12, color = 'black')) + 
      labs(y = 'log2 (mean abundance)') + 
      ggtitle(paste0(marker,'(',celltype, ')'))
    CD8.tmp <- res[res$celltypes==celltype,] %>% dplyr::select(-c('group'))
    colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
    rownames(CD8.tmp) <- NULL
    CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
    colnames(CD8.tmp)[2] <- 'p'
    plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
    plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
      geom_boxplot() + 
      geom_jitter(position = position_jitterdodge(0.5)) +
      theme_classic() + 
      theme(plot.title = element_text(hjust = 0.5,size = 10),
            axis.text = element_text(size = 12, color = 'black'),
            axis.title = element_text(size = 12, color = 'black'),
            legend.text = element_text(size = 12, color = 'black'),
            legend.title = element_text(size = 12, color = 'black')) + 
      labs(y = 'log2 (mean abundance)') + 
      ggtitle(paste0(marker,'(',celltype, ')'))
    
  }
  
  for(i in 1:length(plt1)){
    print(plt1[[i]])
  }
  
  # dev.off()
}
```

## 3.Within BRAFm

```{r, message=FALSE, message=F, warning=F, echo=FALSE, results='hide'}
grp.name= 'PR4.n'
adj.name= NULL
subsetBRAF= TRUE
BRAF.sub='BRAFm'
```

```{r, message=FALSE, message=F, warning=F, echo=FALSE, results='hide'}
source(paste0(root.dir,'Code/Stats.R'))
source(paste0(root.dir,'Code/Func.R'))

cell.abund.obj <- cell.prop.obj <- cell.diff.obj <- list()
i = 0
for(level in c('Compartment','Assignment','Profiling')){
  i = i + 1
  output <- paste0(root.dir,'Result/',level)
  load(file.path(root.dir,'Data/2022_09_29', paste0(level, '.RData')))
  meta.dat$SubjectID <- gsub('WWV54','WVW54',meta.dat$SubjectID)
  
  if(subsetBRAF ==T){
    meta.dat <- meta.dat[meta.dat$file_name !="20201028_AG489_C1" & meta.dat$BRAF == BRAF.sub,]
  }else{
    meta.dat <- meta.dat[meta.dat$file_name !="20201028_AG489_C1", ]
  }
  cell.count <- cell.count[meta.dat$file_name,,drop =F]
  cell.freq <- cell.freq[meta.dat$file_name,,drop =F]
  # cell.count <- cell.count[,unique(BTNK[,tolower(level)])]
  ## cell.diff.obj 
  cell.count0 <- cell.count + 0.5
  size.factor <- rowSums(cell.count0)
  cell.freq <- cell.count0 / size.factor
  cell.freq.base <- cell.freq[meta.dat[meta.dat$TimePoint == 'BASELINE','file_name'], ]
  rownames(cell.freq.base) <- gsub("^([^_]*_[^_]*)_.*$", "\\1", rownames(cell.freq.base))
  base.name <- rownames(cell.freq.base)
  cell.freq.diff <- names <- NULL
  for(k in c('BASELINE','C1','C3','C4')){
    cell.time <- cell.freq[meta.dat[meta.dat$TimePoint == k,'file_name'], ]
    names <- c(names, rownames(cell.time))
    rownames(cell.time) <- gsub("^([^_]*_[^_]*)_.*$", "\\1", rownames(cell.time))
    cell.freq.diff <- rbind(cell.freq.diff, cell.time/cell.freq.base[rownames(cell.time),])
  }
  rownames(cell.freq.diff) <- names
  cell.freq.diff <- log2(cell.freq.diff) #log fold change from the baseline
  # cell.freq.diff.sqrt <- sign(cell.freq.diff) * sqrt(abs(cell.freq.diff ))
  
  cell.count.filter <- cell.count[,colSums(cell.count) > 0]
  cell.diff.obj[[paste0('level', i)]] <- cell.freq.diff[,colnames(cell.count.filter)]
  # cell.abund.obj[[paste0('level', i)]] <- cell.count
  cell.abund.obj[[paste0('level', i)]] <- cell.count.filter
  cell.prop.obj[[paste0('level', i)]] <- cell.freq[,colnames(cell.count)] # not filtered , all cells
}
names(cell.abund.obj) <- names(cell.prop.obj) <- names(cell.diff.obj)  <- c('Compartment','Assignment','Profiling')

meta.samples <- meta.dat[,c('file_name','TimePoint','BRAF','PR2','RunDate','patient_id','PR2.n','PR4.n')] %>% dplyr::rename(SubjectID = patient_id)
colnames(meta.samples)[1] <- 'sam.ids'
meta.samples$PR2.n <- as.factor(meta.samples$PR2.n)
meta.samples$PR4.n <- as.factor(meta.samples$PR4.n)
meta.samples <- within(meta.samples, BRAF <- relevel(BRAF, ref = 1))
meta.samples <- within(meta.samples, PR2 <- relevel(PR2, ref = 1))
```

### DAA: CD8+ T Cell (Central Memory)
```{r echo=F, error=TRUE, fig.height=4, fig.retina=4, fig.width=6, message=FALSE, warning=FALSE, include=T, results="asis"}
load('/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022_09_13/Anno.RData')
CD8TCM = anno[anno$assignment == "CD8+ T Cell (Central Memory)",'profiling']
CD4TEM = anno[anno$assignment == "CD4+ T Cell (Effector Memory)",'profiling']
cell.prop.obj$CD8TCM <- cell.prop.obj$Profiling[,CD8TCM]
cell.prop.obj$CD4TEM <- cell.prop.obj$Profiling[,CD4TEM]
dir.l1 <- '/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Result/2022_12_14_FinalSummary/DAA/'

ree <- NULL
ree <- run(cell.obj = cell.prop.obj, cell.plot.obj = cell.prop.obj, dir.l1 = dir.l1,dir.l2 = 'mean_observed', 
           cell.levels = 'CD8TCM',timepoints =c('BASELINE','C1','C3','C4'),
           transform = 'asinhsqrt',
           feature.dat.type = 'other', filter = F, method = 'lm', subsetBRAF = subsetBRAF, BRAF.sub = BRAF.sub,
           meta.samples = meta.samples, grp.name = grp.name, adj.name = adj.name)

res <- ree$tb[,c('cells','pvalue','time')] %>% spread(time, pvalue) %>%  column_to_rownames('cells')
res0 <- t(res)
reactable(res %>% dplyr::rename_with( ~ paste0(.x,"(p)")) %>% rownames_to_column('celltypes'), pageSizeOptions = 10, pagination = T, filterable = TRUE)
```

```{r echo=F, error=TRUE, fig.height=3, fig.retina=4, fig.width=6, message=FALSE, warning=FALSE, include=T, results="asis"}
plt <- list()
for(celltype in c(CD8TCM)){
  data <- as.data.frame(cell.prop.obj$CD8TCM[,c(celltype), drop =F]) %>% rownames_to_column('sam.ids')
  meta.tmp <- meta.samples[,c('sam.ids','TimePoint','PR4.n')]
  colnames(meta.tmp)[3] <- 'Response'
  data1 <- full_join(data, meta.tmp) 
  p <- as.data.frame(res0[,celltype,drop =F])%>% rownames_to_column('TimePoint')
  colnames(p)[2] <- 'p'
  data2 <- data1 %>% left_join(p)
  data2$TimePoint <- paste0(data2$TimePoint, '(p=',data2$p,')')
  
  plt[[celltype]] <- ggplot(data2, aes(y = (!!as.name(celltype))*100, x = Response, color =!!as.name('Response'))) +
    geom_boxplot() +
    geom_jitter(position = position_jitterdodge(0.5)) +
    facet_wrap(~TimePoint, nrow =1) +
    scale_color_brewer(palette = 'Set1') +
    theme_bw() +
    theme(axis.title = element_text(size = 12),
          axis.text = element_text(size = 12, color = 'black'),
          legend.position = 'none',
          plot.title = element_text(hjust = 0.5,size = 10)) +
    labs(x = '', y = '% of total cells') +
    ggtitle(celltype)
}

# pdf(paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/CD8TCM_profiling_",BRAF.sub,".pdf"), width = 8, height = 4)
for(i in 1:length(plt)){
    print(plt[[i]])
  }
# dev.off()
```

### DAA: CD4+ T Cell (Effector Memory)

```{r echo=F, error=TRUE, fig.height=4, fig.retina=4, fig.width=6, message=FALSE, warning=FALSE, include=T, results="asis"}
ree <- NULL
ree <- run(cell.obj = cell.prop.obj, cell.plot.obj = cell.prop.obj, dir.l1 = dir.l1,dir.l2 = 'mean_observed', 
           cell.levels = 'CD4TEM',timepoints =c('BASELINE','C1','C3','C4'),
           transform = 'asinhsqrt',
           feature.dat.type = 'other', filter = F, method = 'lm', subsetBRAF = subsetBRAF, BRAF.sub = BRAF.sub,
           meta.samples = meta.samples, grp.name = grp.name, adj.name = adj.name)

res <- ree$tb[,c('cells','pvalue','time')] %>% spread(time, pvalue) %>%  column_to_rownames('cells')
res0 <- t(res)
reactable(res %>% dplyr::rename_with( ~ paste0(.x,"(p)")) %>% rownames_to_column('celltypes'), pageSizeOptions = 10, pagination = T, filterable = TRUE)
```

```{r echo=F, error=TRUE, fig.height=3, fig.retina=4, fig.width=6, message=FALSE, warning=FALSE, include=T, results="asis"}
plt <- list()
for(celltype in c(CD4TEM)){
  data <- as.data.frame(cell.prop.obj$CD4TEM[,c(celltype), drop =F]) %>% rownames_to_column('sam.ids')
  meta.tmp <- meta.samples[,c('sam.ids','TimePoint','PR4.n')]
  colnames(meta.tmp)[3] <- 'Response'
  data1 <- full_join(data, meta.tmp) 
  p <- as.data.frame(res0[,celltype,drop =F])%>% rownames_to_column('TimePoint')
  colnames(p)[2] <- 'p'
  data2 <- data1 %>% left_join(p)
  data2$TimePoint <- paste0(data2$TimePoint, '(p=',data2$p,')')
  
  plt[[celltype]] <- ggplot(data2, aes(y = (!!as.name(celltype))*100, x = Response, color =!!as.name('Response'))) +
    geom_boxplot() +
    geom_jitter(position = position_jitterdodge(0.5)) +
    facet_wrap(~TimePoint, nrow =1) +
    scale_color_brewer(palette = 'Set1') +
    theme_bw() +
    theme(axis.title = element_text(size = 12),
          axis.text = element_text(size = 12, color = 'black'),
          legend.position = 'none',
          plot.title = element_text(hjust = 0.5,size = 10)) +
    labs(x = '', y = '% of total cells') +
    ggtitle(celltype)
}

# pdf(paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/CD4TEM_profiling_",BRAF.sub,".pdf"), width = 8, height = 4)
for(i in 1:length(plt)){
    print(plt[[i]])
  }
# dev.off()
```

```{r echo=F, error=TRUE, fig.height=4, fig.retina=4, fig.width=6, message=FALSE, warning=FALSE, include=T, results="asis"}
## exclude outlier sample
level <- 'Profiling'
tmp <- load(paste0("/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022/agg_trans/",level,".RData"))
meta.dat$SubjectID <- gsub('WWV54','WVW54',meta.dat$SubjectID)

if(subsetBRAF == T){
  meta.samples <- meta.samples[meta.samples$sam.ids != "20201028_AG489_C1" & meta.samples$BRAF == BRAF.sub,,drop =F]
}else{
  meta.samples <- meta.samples[meta.samples$sam.ids != "20201028_AG489_C1" ,,drop =F]
}

files <- meta.samples$sam.ids
cell.marker.mean0 <- cell.marker.cvs0 <- cell.marker.median0 <- cell.marker.90qt0 <- cell.marker.99qt0 <- 
  array(NA, c(length(files), length(dimnames(cell.marker.mean)[[2]]), length(dimnames(cell.marker.mean)[[3]])), 
        dimnames = list(files, dimnames(cell.marker.mean)[[2]],dimnames(cell.marker.mean)[[3]]))
for(file in files){
  cell.marker.mean0[file,,] <- cell.marker.mean[file,,] 
  cell.marker.median0[file,,] <- cell.marker.median[file,,] 
  cell.marker.cvs0[file,,] <- cell.marker.cvs[file,,] 
  cell.marker.90qt0[file,,] <- cell.marker.90qt[file,,] 
  cell.marker.99qt0[file,,] <- cell.marker.99qt[file,,] 
}

cell.marker.mean <- cell.marker.mean0
cell.marker.median <- cell.marker.median0
cell.marker.90qt <- cell.marker.90qt0
cell.marker.99qt <- cell.marker.99qt0

### log fold change from baseline
cell.marker.90qt.lfc <- lfc.func(cell.marker = cell.marker.90qt)$cell.marker.lfc
cell.marker.90qt.diff.sqrt <- lfc.func(cell.marker = cell.marker.90qt)$cell.marker.diff.sqrt
cell.marker.mean.lfc <- lfc.func(cell.marker = cell.marker.mean)$cell.marker.lfc

## aggregate CD4+ or CD8+ cells 
level = 'Profiling'
tmp <- load(paste0("/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022/agg_trans/",level,".RData"))
meta.dat$SubjectID <- gsub('WWV54','WVW54',meta.dat$SubjectID)

if(subsetBRAF == T){
  meta.samples <- meta.samples[meta.samples$sam.ids != "20201028_AG489_C1" & meta.samples$BRAF == BRAF.sub,,drop =F]
}else{
  meta.samples <- meta.samples[meta.samples$sam.ids != "20201028_AG489_C1" ,,drop =F]
}

files <- meta.samples$sam.ids
celltypes.CD4 <- unique(BTNK[,tolower(level)])[grep('^CD4\\+\\ T',unique(BTNK[,tolower(level)]))]
celltypes.CD8 <- unique(BTNK[,tolower(level)])[grep('^CD8\\+\\ T',unique(BTNK[,tolower(level)]))]

cell.marker.mean1 <- cell.marker.cvs1 <- cell.marker.median1 <- cell.marker.90qt1 <- cell.marker.99qt1 <- 
  array(NA, c(length(files), 2, length(dimnames(cell.marker.mean)[[3]])), 
        dimnames = list(files, c('CD4+','CD8+'),dimnames(cell.marker.mean)[[3]]))
for(file in files){
  tmp1 <- as.data.frame(cell.marker.mean[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  tmp2 <- as.data.frame(cell.marker.median[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  tmp3 <- as.data.frame(cell.marker.cvs[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  tmp4 <- as.data.frame(cell.marker.90qt[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  tmp5 <- as.data.frame(cell.marker.99qt[file,,][c(celltypes.CD4,celltypes.CD8),,drop =F] ) %>% 
    dplyr::mutate(grp = gsub('T Cell.*','',rownames(.))) %>% 
    group_by(grp) %>% 
    summarise_if(is.numeric, sum, na.rm = TRUE) %>% column_to_rownames('grp') %>% as.matrix
  cell.marker.mean1[file,,] <- tmp1
  cell.marker.median1[file,,] <- tmp2
  cell.marker.cvs1[file,,] <- tmp3
  cell.marker.90qt1[file,,] <- tmp4
  cell.marker.99qt1[file,,] <- tmp5
}

cell.marker.mean.agg <- cell.marker.mean1
cell.marker.median.agg <- cell.marker.median1
cell.marker.90qt.agg <- cell.marker.90qt1
cell.marker.99qt.agg <- cell.marker.99qt1

cell.marker.90qt.agg.lfc <- lfc.func(cell.marker = cell.marker.90qt.agg)$cell.marker.lfc
cell.marker.90qt.agg.diff.sqrt <- lfc.func(cell.marker = cell.marker.90qt.agg)$cell.marker.diff.sqrt
cell.marker.mean.agg.lfc <- lfc.func(cell.marker = cell.marker.mean.agg)$cell.marker.lfc
```


### DEA: CD8+ T Cell (Central Memory)
```{r echo=F, error=TRUE, fig.height=4, fig.retina=4, fig.width=6, message=FALSE, warning=FALSE, include=T, results="asis"}
load('/Users/m216453/Library/Mobile Documents/com~apple~CloudDocs/Documents/Mayo_project/2021_07_23_TinaCyTOF/Data/2022_09_13/Anno.RData')
CD8TCM = anno[anno$assignment == "CD8+ T Cell (Central Memory)",'profiling']
CD4TEM = anno[anno$assignment == "CD4+ T Cell (Effector Memory)",'profiling']

## CD8+TCM and CD4+ T Cell (Effector Memory)
dea.res1 <- NULL
dea.res1 <- perform_DEA_CyTOF(data = cell.marker.mean, celltypes = c(CD8TCM,CD4TEM), 
                              sam.col = 'sam.ids', method = 'lm',transform = 'log2',
                              BRAF.sub =BRAF.sub, subsetBRAF = subsetBRAF,
                              meta.dat = meta.samples, timepoints = c('BASELINE','C1','C3','C4'), 
                              variables = grp.name,adj.name = adj.name)
tb <- dea2tb(dea.res1)
res <- tb$tb[,c(1:2,4,7,10,13)] 
res$group <- 'CD8+ T cell'
res[res$celltypes %in% res$celltypes[grep('^CD4',res$celltypes)],'group'] <- 'CD4+ T cell'
reactable(res[res$celltypes %in% CD8TCM,], pageSizeOptions = 10, pagination = T, filterable = TRUE,
          columns = list(celltypes = colDef(minWidth = 300), markers = colDef(minWidth = 200)))
res0 <- t(res)

# write.csv(res, file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/CD8+TCM_CD4TEM_Profiling[mean]DEA_",BRAF.sub,".csv"), row.names = F)
```

```{r echo=F, error=TRUE, fig.height=3, fig.retina=4, fig.width=7, message=FALSE, warning=FALSE, include=T, results="asis"}
data_summary <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,varname)
  data_sum <- rename(data_sum, c("mean" = varname))
  return(data_sum)
}

for(celltype in unique(res[res$group=='CD8+ T cell','celltypes'])){
  # pdf(paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/",BRAF.sub,'_',celltype,".pdf"), width =8, height = 4)
  CD8.df <- (cell.marker.mean[,celltype,])
  CD8.df <- log2(CD8.df)
  
  plt <- plt1 <- list()
  for(marker in unique(res$markers)){
    plt.df <- inner_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                        meta.samples[,c('sam.ids','PR4.n','TimePoint')])
    colnames(plt.df)[2] <- 'marker'
    colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
    plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
    plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
      geom_line() +
      geom_point()+
      geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
      theme_classic() + 
      theme(plot.title = element_text(hjust = 0.5,size = 8),
            axis.text = element_text(size = 12, color = 'black'),
            axis.title = element_text(size = 12, color = 'black'),
            legend.text = element_text(size = 12, color = 'black'),
            legend.title = element_text(size = 12, color = 'black')) + 
      labs(y = 'log2 (mean abundance)') + 
      ggtitle(paste0(marker,'(',celltype, ')'))
    CD8.tmp <- res[res$celltypes==celltype,] %>% dplyr::select(-c('group'))
    colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
    rownames(CD8.tmp) <- NULL
    CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
    colnames(CD8.tmp)[2] <- 'p'
    plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
    plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
      geom_boxplot() + 
      geom_jitter(position = position_jitterdodge(0.5)) +
      theme_classic() + 
      theme(plot.title = element_text(hjust = 0.5,size = 10),
            axis.text = element_text(size = 12, color = 'black'),
            axis.title = element_text(size = 12, color = 'black'),
            legend.text = element_text(size = 12, color = 'black'),
            legend.title = element_text(size = 12, color = 'black')) + 
      labs(y = 'log2 (mean abundance)') + 
      ggtitle(paste0(marker,'(',celltype, ')'))
    
  }
  for(i in 1:length(plt1)){
    print(plt1[[i]])
  }
  # dev.off()
}
```

### DEA: CD4+ T Cell (Effector Memory)
```{r echo=F, error=TRUE, fig.height=3, fig.retina=4, fig.width=7, message=FALSE, warning=FALSE, include=T, results="asis"}
reactable(res[res$celltypes %in% CD4TEM,], pageSizeOptions = 10, pagination = T, filterable = TRUE,
          columns = list(celltypes = colDef(minWidth = 300), markers = colDef(minWidth = 200)))
data_summary <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,varname)
  data_sum <- rename(data_sum, c("mean" = varname))
  return(data_sum)
}

for(celltype in unique(res[res$group=='CD4+ T cell','celltypes'])){
  # pdf(paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Code/Report_Summary/Folder2/",BRAF.sub,'_',celltype,".pdf"), width =8, height = 4)
  CD8.df <- (cell.marker.mean[,celltype,])
  CD8.df <- log2(CD8.df)
  
  plt <- plt1 <- list()
  for(marker in unique(res$markers)){
    plt.df <- inner_join(as.data.frame(CD8.df) %>% dplyr::select(marker) %>% rownames_to_column('sam.ids'), 
                        meta.samples[,c('sam.ids','PR4.n','TimePoint')])
    colnames(plt.df)[2] <- 'marker'
    colnames(plt.df) <- gsub('PR4.n','Response',colnames(plt.df))
    plt.summary <- data_summary(data = plt.df, varname="marker",groupnames=c("Response", "TimePoint"))
    plt[[marker]] <- ggplot(plt.summary, aes(x = TimePoint, y = marker,group = Response, color = Response)) + 
      geom_line() +
      geom_point()+
      geom_errorbar(aes(ymin=marker-sd, ymax=marker+sd), width=.2,position=position_dodge(0.05)) +
      theme_classic() + 
      theme(plot.title = element_text(hjust = 0.5,size = 8),
            axis.text = element_text(size = 12, color = 'black'),
            axis.title = element_text(size = 12, color = 'black'),
            legend.text = element_text(size = 12, color = 'black'),
            legend.title = element_text(size = 12, color = 'black')) + 
      labs(y = 'log2 (mean abundance)') + 
      ggtitle(paste0(marker,'(',celltype, ')'))
    CD8.tmp <- res[res$celltypes==celltype,] %>% dplyr::select(-c('group'))
    colnames(CD8.tmp) <- gsub('\\(.*','',colnames(CD8.tmp) )
    rownames(CD8.tmp) <- NULL
    CD8.tmp <- as.data.frame((t(CD8.tmp[,-1] %>% column_to_rownames('markers')))[,marker,drop =F]) %>% rownames_to_column('TimePoint')
    colnames(CD8.tmp)[2] <- 'p'
    plt.df1 <- left_join(plt.df, CD8.tmp) %>% mutate(TimePoint = paste0(TimePoint,'(p=',p,')'))
    plt1[[marker]] <- ggplot(plt.df1, aes(x = TimePoint, y = marker,color = Response)) + 
      geom_boxplot() + 
      geom_jitter(position = position_jitterdodge(0.5)) +
      theme_classic() + 
      theme(plot.title = element_text(hjust = 0.5,size = 10),
            axis.text = element_text(size = 12, color = 'black'),
            axis.title = element_text(size = 12, color = 'black'),
            legend.text = element_text(size = 12, color = 'black'),
            legend.title = element_text(size = 12, color = 'black')) + 
      labs(y = 'log2 (mean abundance)') + 
      ggtitle(paste0(marker,'(',celltype, ')'))
    
  }
  
  for(i in 1:length(plt1)){
    print(plt1[[i]])
  }
  
  # dev.off()
}
```









# Figure 1B (within CD8+T) [add Date May 15, 2023], I want to see as manuscript described, if within CD4+T/CD8+T, CD8+Tcm is significant or not
```{r, message=FALSE, message=F, warning=F, echo=FALSE, results='hide'}

CD4 <- c("CD4+ T Cell (Central Memory)","CD4+ T Cell (Effector Memory)","CD4+ T Cell (EMRA)","CD4+ T Cell (Naive)")
CD8 <- c("CD8+ T Cell (Central Memory)","CD8+ T Cell (Effector Memory)","CD8+ T Cell (EMRA)","CD8+ T Cell (Naive)")
dir.l1 <- '/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Result/2022_12_14_FinalSummary/DAA/'
### Figure 1B
CD8T <- cell.prop.obj$Assignment[,unique(BTNK$assignment)]
CD8T.prop <- CD8T /rowSums(CD8T)
rowSums(CD8T.prop);rowSums(CD4T.prop)

cell.prop.obj$CD8p <- CD8T.prop
cell.prop.obj$CD8psub <- CD8T.prop[,CD8]/rowSums(CD8T.prop[,CD8])

ree <- NULL
ree <- run(cell.obj = cell.prop.obj, cell.plot.obj = cell.prop.obj, 
           dir.l1 = dir.l1, dir.l2 = 'mean_observed', 
           cell.levels = 'CD8p',timepoints =c('BASELINE','C1','C3','C4'),
           transform = 'asinhsqrt',
           feature.dat.type = 'other', filter = F, method = 'lm', subsetBRAF = subsetBRAF, BRAF.sub = BRAF.sub,
           meta.samples = meta.samples, grp.name = grp.name, adj.name = adj.name)
res <- ree$tb[,c('cells','pvalue','time')] %>% spread(time, pvalue) %>% column_to_rownames('cells')
reactable(res)
res0 <- t(res)

ree <- NULL
ree <- run(cell.obj = cell.prop.obj, cell.plot.obj = cell.prop.obj, 
           dir.l1 = dir.l1, dir.l2 = 'mean_observed', 
           cell.levels = 'CD8psub',timepoints =c('BASELINE','C1','C3','C4'),
           transform = 'asinhsqrt',
           feature.dat.type = 'other', filter = F, method = 'lm', subsetBRAF = subsetBRAF, BRAF.sub = BRAF.sub,
           meta.samples = meta.samples, grp.name = grp.name, adj.name = adj.name)
res <- ree$tb[,c('cells','pvalue','time')] %>% spread(time, pvalue) %>% column_to_rownames('cells')
reactable(res)
```

```{r echo=F, error=TRUE, fig.height=6, fig.retina=4, fig.width=14, message=FALSE, warning=FALSE, include=T, results="asis"}
plt <- list()
for(celltype in colnames(cell.prop.obj$CD48p)){
  data <- as.data.frame(cell.prop.obj$CD48p[,c(celltype), drop =F]) %>% rownames_to_column('sam.ids')
  meta.tmp <- meta.samples[,c('sam.ids','TimePoint','PR4.n')]
  colnames(meta.tmp)[3] <- 'Response'
  data1 <- full_join(data, meta.tmp) 
  p <- as.data.frame(res0[,celltype,drop =F])%>% rownames_to_column('TimePoint')
  colnames(p)[2] <- 'p'
  data2 <- data1 %>% left_join(p)
  data2$TimePoint <- paste0(data2$TimePoint, '(p=',data2$p,')')
  data2$Response <- gsub('good',paste0(as.character(expression("\u2264")),10),data2$Response)
  data2$Response <- gsub('bad','>10',data2$Response)
  data2 <- within(data2, Response <- factor(Response, levels = c(paste0(as.character(expression("\u2264")),10),'>10')))
  plt[[celltype]] <- ggplot(data2, aes(y = (!!as.name(celltype))*100, x = Response, color =!!as.name('Response'))) +
    geom_boxplot() +
    geom_jitter(position = position_jitterdodge(0.5)) +
    facet_wrap(~TimePoint, nrow =1) +
    scale_color_manual(values = c("≤10"=brewer.pal(8,'Set1')[2],">10"=brewer.pal(8,'Set1')[1])) +
    theme_bw() +
    theme(axis.title = element_text(size = 14),
          panel.grid = element_blank(),
          strip.text.x = element_text(size = 12),
          axis.text = element_text(size = 12, color = 'black'),
          legend.position = 'none',
          plot.title = element_text(hjust = 0.5)) +
    labs(x = 'Pathologic response (% viable tumor cells)', y = '% of total cells') +
    ggtitle(celltype)
}
pp <- ggarrange(plt$`CD8+ T Cell (Central Memory)`, plt$`CD8+ T Cell (Effector Memory)`, plt$`CD8+ T Cell (EMRA)`, plt$`CD8+ T Cell (Naive)`)
# pp <- ggarrange(plt$`CD4+ T cells`, plt$`CD8+ T cells`, plt$`B cell`, plt$`NK cell`, plt$`gd T Cell`,plt$`CD8+ T Cell (Central Memory)`)
print(pp)
# ggsave(file = paste0("/Users/m216453/lu/Documents/Mayo_project/2021_07_23_TinaCyTOF/Report/Report_Summary/Folder2/Figure1B_",BRAF.sub,"new.pdf"), width =20, height = 8)
```
